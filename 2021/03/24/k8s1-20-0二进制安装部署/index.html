<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="1.  基本环境配置       K8s Service网段：10.96.0.0&#x2F;12 K8s Pod网段：172.16.0.0&#x2F;12 系统环境： 12root@k8s-master01 ~:# cat &#x2F;etc&#x2F;redhat-release CentOS Linux release 7.5.1804 (Core)   配置所有节点主机名： 12345ho">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s1.20.0二进制安装部署">
<meta property="og:url" content="http://zhho.cn/2021/03/24/k8s1-20-0%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="Hao&#39;s blog">
<meta property="og:description" content="1.  基本环境配置       K8s Service网段：10.96.0.0&#x2F;12 K8s Pod网段：172.16.0.0&#x2F;12 系统环境： 12root@k8s-master01 ~:# cat &#x2F;etc&#x2F;redhat-release CentOS Linux release 7.5.1804 (Core)   配置所有节点主机名： 12345ho">
<meta property="og:locale">
<meta property="og:image" content="file:///C:/Users/pc/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg">
<meta property="article:published_time" content="2021-03-24T09:24:15.000Z">
<meta property="article:modified_time" content="2021-03-26T08:48:41.393Z">
<meta property="article:author" content="Hao Zhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="file:///C:/Users/pc/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg"><title>k8s1.20.0二进制安装部署 | Hao's blog</title><link ref="canonical" href="http://zhho.cn/2021/03/24/k8s1-20-0%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.1.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hao's blog</div><div class="header-banner-info__subtitle">No pains ,no gains</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">k8s1.20.0二进制安装部署</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-03-24</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-03-26</span></span></div></header><div class="post-body">
        <h4 id="1-基本环境配置"   >
          <a href="#1-基本环境配置" class="heading-link"><i class="fas fa-link"></i></a>1.  基本环境配置</h4>
      <p>K8s Service网段：10.96.0.0/12</p>
<p>K8s Pod网段：172.16.0.0/12</p>
<p>系统环境：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master01 ~:# cat &#x2F;etc&#x2F;redhat-release </span><br><span class="line">CentOS Linux release 7.5.1804 (Core) </span><br></pre></td></tr></table></div></figure>

<p>配置所有节点主机名：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01</span><br><span class="line">hostnamectl set-hostname k8s-master02</span><br><span class="line">hostnamectl set-hostname k8s-master03</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br></pre></td></tr></table></div></figure>

<a id="more"></a>

<p>配置所有节点hosts文件：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master01 ~:# cat &#x2F;etc&#x2F;hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">172.20.103.181 k8s-master01</span><br><span class="line">172.20.103.182 k8s-master02</span><br><span class="line">172.20.103.183 k8s-master03</span><br><span class="line">172.20.103.180 k8s-master-lb # 如果不是高可用集群，该IP为Master01的IP</span><br><span class="line">172.20.103.184 k8s-node01</span><br><span class="line">172.20.103.185 k8s-node02</span><br></pre></td></tr></table></div></figure>

<p>CentOS 7替换yum源如下：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line">sed -i -e &#39;&#x2F;mirrors.cloud.aliyuncs.com&#x2F;d&#39; -e &#39;&#x2F;mirrors.aliyuncs.com&#x2F;d&#39; &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo</span><br></pre></td></tr></table></div></figure>

<p>安装必备工具：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y</span><br></pre></td></tr></table></div></figure>

<p>所有节点关闭firewalld 、dnsmasq、selinux(CentOS7需要关闭NetworkManager，CentOS8不需要)：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld </span><br><span class="line">systemctl disable --now dnsmasq</span><br><span class="line">systemctl disable --now NetworkManager</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#39;s#SELINUX&#x3D;enforcing#SELINUX&#x3D;disabled#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;selinux</span><br><span class="line">sed -i &#39;s#SELINUX&#x3D;enforcing#SELINUX&#x3D;disabled#g&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br></pre></td></tr></table></div></figure>

<p>所有节点关闭swap分区，fstab注释swap：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness&#x3D;0</span><br><span class="line">sed -ri &#39;&#x2F;^[^#]*swap&#x2F;s@^@#@&#39; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></div></figure>

<p>所有节点同步时间：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http:&#x2F;&#x2F;mirrors.wlnmp.com&#x2F;centos&#x2F;wlnmp-release-centos.noarch.rpm</span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ln -sf &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime</span><br><span class="line">echo &#39;Asia&#x2F;Shanghai&#39; &gt;&#x2F;etc&#x2F;timezone</span><br><span class="line">ntpdate time2.aliyun.com</span><br><span class="line">\# 加入到crontab</span><br><span class="line">crontab -e</span><br><span class="line">*&#x2F;5 * * * * &#x2F;usr&#x2F;sbin&#x2F;ntpdate time2.aliyun.com</span><br></pre></td></tr></table></div></figure>

<p>所有节点配置limit：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ulimit -SHn 65535</span><br><span class="line">cat &gt;&gt; &#x2F;etc&#x2F;security&#x2F;limits.conf &lt;&lt; EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Master01上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# ssh-keygen -t rsa</span><br></pre></td></tr></table></div></figure>

<p> Master01配置免密码登录其他节点:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# for i in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh&#x2F;id_rsa.pub $i;done</span><br></pre></td></tr></table></div></figure>

<p>　Master01下载安装文件:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# cd &#x2F;root&#x2F; ; git clone https:&#x2F;&#x2F;github.com&#x2F;dotbalo&#x2F;k8s-ha-install.git</span><br><span class="line">Cloning into &#39;k8s-ha-install&#39;...</span><br><span class="line">remote: Enumerating objects: 12, done.</span><br><span class="line">remote: Counting objects: 100% (12&#x2F;12), done.</span><br><span class="line">remote: Compressing objects: 100% (11&#x2F;11), done.</span><br><span class="line">remote: Total 461 (delta 2), reused 5 (delta 1), pack-reused 449</span><br><span class="line">Receiving objects: 100% (461&#x2F;461), 19.52 MiB | 4.04 MiB&#x2F;s, done.</span><br><span class="line">Resolving deltas: 100% (163&#x2F;163), done.</span><br></pre></td></tr></table></div></figure>

<p>所有节点升级系统并重启，此处升级没有升级内核，下节会单独升级内核：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y --exclude&#x3D;kernel* &amp;&amp; reboot #CentOS7需要升级，CentOS8可以按需升级系统</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-内核升级"   >
          <a href="#2-内核升级" class="heading-link"><i class="fas fa-link"></i></a>2. 内核升级</h4>
      <p>CentOS7 需要升级内核至4.18+，本地升级的版本为4.19</p>
<p>在master01节点下载内核：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root</span><br><span class="line">wget http:&#x2F;&#x2F;193.49.22.109&#x2F;elrepo&#x2F;kernel&#x2F;el7&#x2F;x86_64&#x2F;RPMS&#x2F;kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</span><br><span class="line">wget http:&#x2F;&#x2F;193.49.22.109&#x2F;elrepo&#x2F;kernel&#x2F;el7&#x2F;x86_64&#x2F;RPMS&#x2F;kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</span><br></pre></td></tr></table></div></figure>

<p>从master01节点传到其他节点：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm $i:&#x2F;root&#x2F; ; done</span><br></pre></td></tr></table></div></figure>

<p>所有节点安装内核:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root &amp;&amp; yum localinstall -y kernel-ml*</span><br></pre></td></tr></table></div></figure>


<p>所有节点更改内核启动顺序:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub2-set-default 0 &amp;&amp; grub2-mkconfig -o &#x2F;etc&#x2F;grub2.cfg</span><br><span class="line">grubby --args&#x3D;&quot;user_namespace.enable&#x3D;1&quot; --update-kernel&#x3D;&quot;$(grubby --default-kernel)&quot;</span><br></pre></td></tr></table></div></figure>

<p>检查默认内核是不是4.19:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master02 ~]# grubby --default-kernel</span><br><span class="line">&#x2F;boot&#x2F;vmlinuz-4.19.12-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></div></figure>

<p>所有节点重启，然后检查内核是不是4.19</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master02 ~]# uname -a</span><br><span class="line">Linux k8s-master02 4.19.12-1.el7.elrepo.x86_64 #1 SMP Fri Dec 21 11:06:36 EST 2018 x86_64 x86_64 x86_64 GNU&#x2F;Linux</span><br></pre></td></tr></table></div></figure>

<p>所有节点安装ipvsadm：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br></pre></td></tr></table></div></figure>

<p>所有节点配置ipvs模块，在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack， 4.18以下使用nf_conntrack_ipv4即可：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf</span><br><span class="line"># 加入以下内容</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line"></span><br><span class="line">然后执行: systemctl enable --now systemd-modules-load.service</span><br></pre></td></tr></table></div></figure>

<p> 检查是否加载：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">nf_conntrack_ipv4   16384 23 </span><br><span class="line">nf_defrag_ipv4     16384 1 nf_conntrack_ipv4</span><br><span class="line">nf_conntrack     135168 10 xt_conntrack,nf_conntrack_ipv6,nf_conntrack_ipv4,nf_nat,nf_nat_ipv6,ipt_MASQUERADE,nf_nat_ipv4,xt_nat,nf_conntrack_netlink,ip_vs</span><br></pre></td></tr></table></div></figure>

<p>开启一些k8s集群中必须的内核参数，所有节点配置k8s内核：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1</span><br><span class="line">fs.may_detach_mounts &#x3D; 1</span><br><span class="line">vm.overcommit_memory&#x3D;1</span><br><span class="line">vm.panic_on_oom&#x3D;0</span><br><span class="line">fs.inotify.max_user_watches&#x3D;89100</span><br><span class="line">fs.file-max&#x3D;52706963</span><br><span class="line">fs.nr_open&#x3D;52706963</span><br><span class="line">net.netfilter.nf_conntrack_max&#x3D;2310720</span><br><span class="line">net.ipv4.tcp_keepalive_time &#x3D; 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes &#x3D; 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl &#x3D;15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets &#x3D; 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse &#x3D; 1</span><br><span class="line">net.ipv4.tcp_max_orphans &#x3D; 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries &#x3D; 3</span><br><span class="line">net.ipv4.tcp_syncookies &#x3D; 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog &#x3D; 16384</span><br><span class="line">net.ipv4.ip_conntrack_max &#x3D; 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog &#x3D; 16384</span><br><span class="line">net.ipv4.tcp_timestamps &#x3D; 0</span><br><span class="line">net.core.somaxconn &#x3D; 16384</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></div></figure>

<p> 所有节点配置完内核后，重启服务器，保证重启后内核依旧加载</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br><span class="line">lsmod | grep --color&#x3D;auto -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></div></figure>


        <h4 id="3-基本组件安装"   >
          <a href="#3-基本组件安装" class="heading-link"><i class="fas fa-link"></i></a>3. 基本组件安装</h4>
      <p>本节主要安装的是集群中用到的各种组件，比如Docker-ce、Kubernetes各组件等。</p>

        <h5 id="3-1-Docker安装"   >
          <a href="#3-1-Docker安装" class="heading-link"><i class="fas fa-link"></i></a>3.1  Docker安装</h5>
      <p>所有节点安装Docker-ce 19.03</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-19.03.* -y</span><br></pre></td></tr></table></div></figure>

<p>温馨提示：</p>
<p>由于新版kubelet建议使用systemd，所以可以把docker的CgroupDriver改成systemd</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;docker</span><br><span class="line">cat &gt; &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line"> &quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>所有节点设置开机自启动Docker：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable --now docker</span><br></pre></td></tr></table></div></figure>


        <h5 id="3-2-K8s及etcd安装"   >
          <a href="#3-2-K8s及etcd安装" class="heading-link"><i class="fas fa-link"></i></a>3.2  K8s及etcd安装</h5>
      <p>Master01下载kubernetes安装包</p>
<p>[root@k8s-master01 ~]# wget <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://dl.k8s.io/v1.20.0/kubernetes-server-linux-amd64.tar.gz" >https://dl.k8s.io/v1.20.0/kubernetes-server-linux-amd64.tar.gz</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>注意目前版本是1.20.0学员安装时需要下载最新的1.20.x版本：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md" >https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>打开页面后点击：</p>
<p><img src="file:///C:/Users/pc/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg" alt="img"></p>
<p><strong>以下操作都在master01执行</strong></p>
<p>下载etcd安装包:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# wget https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.4.13&#x2F;etcd-v3.4.13-linux-amd64.tar.gz</span><br></pre></td></tr></table></div></figure>

<p>解压kubernetes安装文件:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# tar -xf kubernetes-server-linux-amd64.tar.gz --strip-components&#x3D;3 -C &#x2F;usr&#x2F;local&#x2F;bin kubernetes&#x2F;server&#x2F;bin&#x2F;kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br></pre></td></tr></table></div></figure>

<p>解压etcd安装文件:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# tar -zxvf etcd-v3.4.13-linux-amd64.tar.gz --strip-components&#x3D;1 -C &#x2F;usr&#x2F;local&#x2F;bin etcd-v3.4.13-linux-amd64&#x2F;etcd&#123;,ctl&#125;</span><br></pre></td></tr></table></div></figure>

<p>版本查看:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubelet --version</span><br><span class="line">Kubernetes v1.20.0</span><br><span class="line">[root@k8s-master01 ~]# etcdctl version</span><br><span class="line">etcdctl version: 3.4.13</span><br><span class="line">API version: 3.4 </span><br></pre></td></tr></table></div></figure>

<p>将组件发送到其他节点:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MasterNodes&#x3D;&#39;k8s-master02 k8s-master03&#39;</span><br><span class="line">WorkNodes&#x3D;&#39;k8s-node01 k8s-node02&#39;</span><br><span class="line">for NODE in $MasterNodes; do echo $NODE; scp &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $NODE:&#x2F;usr&#x2F;local&#x2F;bin&#x2F;; scp &#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd* $NODE:&#x2F;usr&#x2F;local&#x2F;bin&#x2F;; done</span><br><span class="line">for NODE in $WorkNodes; do scp &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kube&#123;let,-proxy&#125; $NODE:&#x2F;usr&#x2F;local&#x2F;bin&#x2F; ; done</span><br></pre></td></tr></table></div></figure>

<p>k8s github : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/" >https://github.com/kubernetes/kubernetes/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>所有节点创建/opt/cni/bin目录:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;opt&#x2F;cni&#x2F;bin</span><br></pre></td></tr></table></div></figure>

<p>切换到1.20.x分支（其他版本可以切换到其他分支）:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd k8s-ha-install &amp;&amp; git checkout manual-installation-v1.20.x</span><br></pre></td></tr></table></div></figure>


        <h4 id="4-生成证书"   >
          <a href="#4-生成证书" class="heading-link"><i class="fas fa-link"></i></a>4. 生成证书</h4>
      <p> <strong>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</strong></p>
<p>Master01下载生成证书工具（下载不成功可以去百度网盘）</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl_linux-amd64&quot; -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssl</span><br><span class="line">wget &quot;https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssljson_linux-amd64&quot; -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssljson</span><br><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssl &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssljson</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-1-etcd证书"   >
          <a href="#4-1-etcd证书" class="heading-link"><i class="fas fa-link"></i></a>4.1 etcd证书</h5>
      <p>所有Master节点创建etcd证书目录:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;etcd&#x2F;ssl -p</span><br></pre></td></tr></table></div></figure>

<p> 所有节点创建kubernetes相关目录:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;pki</span><br></pre></td></tr></table></div></figure>

<p> Master01节点生成etcd证书，生成证书的CSR文件：证书签名请求文件，配置了一些域名、公司、单位</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]# cd &#x2F;root&#x2F;k8s-ha-install&#x2F;pki</span><br><span class="line">#生成etcd CA证书和CA证书的key</span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare &#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;etcd-ca</span><br><span class="line">cfssl gencert \</span><br><span class="line">-ca&#x3D;&#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;etcd-ca.pem \</span><br><span class="line">-ca-key&#x3D;&#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;etcd-ca-key.pem \</span><br><span class="line">-config&#x3D;ca-config.json \</span><br><span class="line">-hostname&#x3D;127.0.0.1,k8s-master01,k8s-master02,k8s-master03,172.20.103.181,172.20.103.182,172.20.103.183 \</span><br><span class="line">-profile&#x3D;kubernetes \</span><br><span class="line">etcd-csr.json | cfssljson -bare &#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;etcd</span><br><span class="line">#执行结果</span><br><span class="line">2021&#x2F;03&#x2F;25 15:37:35 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:37:35 [INFO] generate received request</span><br><span class="line">2021&#x2F;03&#x2F;25 15:37:35 [INFO] received CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:37:35 [INFO] generating key: rsa-2048</span><br><span class="line">2021&#x2F;03&#x2F;25 15:37:36 [INFO] encoded CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:37:36 [INFO] signed certificate with serial number 531361379310927773836849333894840754500131829602</span><br><span class="line"></span><br><span class="line">2021&#x2F;03&#x2F;25 15:38:06 [INFO] generate received request</span><br><span class="line">2021&#x2F;03&#x2F;25 15:38:06 [INFO] received CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:38:06 [INFO] generating key: rsa-2048</span><br><span class="line">2021&#x2F;03&#x2F;25 15:38:06 [INFO] encoded CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:38:06 [INFO] signed certificate with serial number 237443018015069176569281183324409939856062503697</span><br></pre></td></tr></table></div></figure>

<p>将证书复制到其他节点：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MasterNodes&#x3D;&#39;k8s-master02 k8s-master03&#39;</span><br><span class="line">WorkNodes&#x3D;&#39;k8s-node01 k8s-node02&#39;</span><br><span class="line">for NODE in $MasterNodes; do</span><br><span class="line">   ssh $NODE &quot;mkdir -p &#x2F;etc&#x2F;etcd&#x2F;ssl&quot;</span><br><span class="line">   for FILE in etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem; do</span><br><span class="line">    scp &#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;$&#123;FILE&#125; $NODE:&#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;$&#123;FILE&#125;</span><br><span class="line">   done</span><br><span class="line">done</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-2-k8s组件证书"   >
          <a href="#4-2-k8s组件证书" class="heading-link"><i class="fas fa-link"></i></a>4.2   k8s组件证书</h5>
      <p>Master01生成kubernetes证书：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]# cd &#x2F;root&#x2F;k8s-ha-install&#x2F;pki</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#10.96.0.是k8s service的网段，如果说需要更改k8s service网段，那就需要更改10.96.0.1，</span><br><span class="line">#如果不是高可用集群，172.20.103.180为Master01的IP</span><br><span class="line">cfssl gencert  -ca&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem  -ca-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca-key.pem  -config&#x3D;ca-config.json  -hostname&#x3D;10.96.0.1,172.20.103.180,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,172.20.103.181,172.20.103.182,172.20.103.183  -profile&#x3D;kubernetes  apiserver-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver</span><br><span class="line"></span><br><span class="line">#生成apiserver的聚合证书。Requestheader-client-xxx requestheader-allowwd-xxx:aggerator</span><br><span class="line">cfssl gencert  -initca front-proxy-ca-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca </span><br><span class="line">cfssl gencert  -ca&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.pem  -ca-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca-key.pem  -config&#x3D;ca-config.json  -profile&#x3D;kubernetes  front-proxy-client-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-client</span><br><span class="line"></span><br><span class="line">#返回结果（忽略警告）</span><br><span class="line">2021&#x2F;03&#x2F;25 15:46:58 [INFO] generate received request</span><br><span class="line">2021&#x2F;03&#x2F;25 15:46:58 [INFO] received CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:46:58 [INFO] generating key: rsa-2048</span><br><span class="line">2021&#x2F;03&#x2F;25 15:46:58 [INFO] encoded CSR</span><br><span class="line">2021&#x2F;03&#x2F;25 15:46:58 [INFO] signed certificate with serial number 540745177069209309072809901900604794276852591352</span><br><span class="line">2021&#x2F;03&#x2F;25 15:46:58 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA&#x2F;Browser Forum (https:&#x2F;&#x2F;cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></div></figure>

<p> 生成controller-manage的证书：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">  -ca&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes \</span><br><span class="line">  manager-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;controller-manager</span><br><span class="line"></span><br><span class="line">#注意，如果不是高可用集群，172.20.103.180:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span><br><span class="line"># set-cluster：设置一个集群项，</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem \</span><br><span class="line">   --embed-certs&#x3D;true \</span><br><span class="line">   --server&#x3D;https:&#x2F;&#x2F;172.20.103.180:8443 \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"> # 设置一个环境项，一个上下文</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;system:kube-controller-manager \</span><br><span class="line">  --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"># set-credentials 设置一个用户项</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">   --client-certificate&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;controller-manager.pem \</span><br><span class="line">   --client-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;controller-manager-key.pem \</span><br><span class="line">   --embed-certs&#x3D;true \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"># 使用某个环境当做默认环境</span><br><span class="line">kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">  -ca&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes \</span><br><span class="line">  scheduler-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;scheduler</span><br><span class="line"></span><br><span class="line"># 注意，如果不是高可用集群，172.20.103.180:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">   --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem \</span><br><span class="line">   --embed-certs&#x3D;true \</span><br><span class="line">   --server&#x3D;https:&#x2F;&#x2F;172.20.103.180:8443 \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">   --client-certificate&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;scheduler.pem \</span><br><span class="line">   --client-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;scheduler-key.pem \</span><br><span class="line">   --embed-certs&#x3D;true \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-scheduler@kubernetes \</span><br><span class="line">   --cluster&#x3D;kubernetes \</span><br><span class="line">   --user&#x3D;system:kube-scheduler \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">  -ca&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes \</span><br><span class="line">  admin-csr.json | cfssljson -bare &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;admin</span><br><span class="line"></span><br><span class="line"># 注意，如果不是高可用集群，172.20.103.180:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes   --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.pem   --embed-certs&#x3D;true   --server&#x3D;https:&#x2F;&#x2F;172.20.103.180:8443   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubernetes-admin   --client-certificate&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;admin.pem   --client-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;admin-key.pem   --embed-certs&#x3D;true   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes-admin@kubernetes   --cluster&#x3D;kubernetes   --user&#x3D;kubernetes-admin   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes   --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.kubeconfig</span><br><span class="line"></span><br><span class="line">#创建ServiceAccount Key à secret</span><br><span class="line"></span><br><span class="line">openssl genrsa -out &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.key 2048</span><br><span class="line"></span><br><span class="line">#返回结果</span><br><span class="line"></span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">...................................................................................+++++</span><br><span class="line">...............+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"> </span><br><span class="line">openssl rsa -in &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.key -pubout -out &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.pub</span><br><span class="line"></span><br><span class="line">#发送证书至其他节点</span><br><span class="line">for NODE in k8s-master02 k8s-master03; do </span><br><span class="line"> for FILE in $(ls &#x2F;etc&#x2F;kubernetes&#x2F;pki | grep -v etcd); do </span><br><span class="line"> scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;$&#123;FILE&#125; $NODE:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;$&#123;FILE&#125;;</span><br><span class="line"> done; </span><br><span class="line"> for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do </span><br><span class="line"> scp &#x2F;etc&#x2F;kubernetes&#x2F;$&#123;FILE&#125; $NODE:&#x2F;etc&#x2F;kubernetes&#x2F;$&#123;FILE&#125;;</span><br><span class="line"> done;</span><br><span class="line"> done</span><br></pre></td></tr></table></div></figure>

<p>查看证书文件</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]# ls &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">admin.csr   apiserver.csr   ca.csr   controller-manager.csr   front-proxy-ca.csr   front-proxy-client.csr   sa.key     scheduler-key.pem</span><br><span class="line">admin-key.pem apiserver-key.pem ca-key.pem controller-manager-key.pem front-proxy-ca-key.pem front-proxy-client-key.pem sa.pub     scheduler.pem</span><br><span class="line">admin.pem   apiserver.pem   ca.pem   controller-manager.pem   front-proxy-ca.pem   front-proxy-client.pem   scheduler.csr</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]# ls &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F; |wc -l</span><br><span class="line">23</span><br></pre></td></tr></table></div></figure>


        <h4 id="5-Kubernetes系统组件配置"   >
          <a href="#5-Kubernetes系统组件配置" class="heading-link"><i class="fas fa-link"></i></a>5. Kubernetes系统组件配置</h4>
      
        <h5 id="5-1-Etcd配置"   >
          <a href="#5-1-Etcd配置" class="heading-link"><i class="fas fa-link"></i></a>5.1  Etcd配置</h5>
      <p>etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</p>

        <h6 id="5-1-1-Master01"   >
          <a href="#5-1-1-Master01" class="heading-link"><i class="fas fa-link"></i></a>5.1.1  Master01</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;etcd&#x2F;etcd.config.yml</span><br><span class="line">name: &#39;k8s-master01&#39;</span><br><span class="line">data-dir: &#x2F;var&#x2F;lib&#x2F;etcd</span><br><span class="line">wal-dir: &#x2F;var&#x2F;lib&#x2F;etcd&#x2F;wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#39;https:&#x2F;&#x2F;172.20.103.181:2380&#39;</span><br><span class="line">listen-client-urls: &#39;https:&#x2F;&#x2F;172.20.103.181:2379,http:&#x2F;&#x2F;127.0.0.1:2379&#39;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#39;https:&#x2F;&#x2F;172.20.103.181:2380&#39;</span><br><span class="line">advertise-client-urls: &#39;https:&#x2F;&#x2F;172.20.103.181:2379&#39;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#39;proxy&#39;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#39;k8s-master01&#x3D;https:&#x2F;&#x2F;172.20.103.181:2380,k8s-master02&#x3D;https:&#x2F;&#x2F;172.20.103.182:2380,k8s-master03&#x3D;https:&#x2F;&#x2F;172.20.103.183:2380&#39;</span><br><span class="line">initial-cluster-token: &#39;etcd-k8s-cluster&#39;</span><br><span class="line">initial-cluster-state: &#39;new&#39;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#39;off&#39;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem&#39;</span><br><span class="line">  key-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem&#39;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem&#39;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem&#39;</span><br><span class="line">  key-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem&#39;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem&#39;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br></pre></td></tr></table></div></figure>


        <h6 id="5-1-2-Master02"   >
          <a href="#5-1-2-Master02" class="heading-link"><i class="fas fa-link"></i></a>5.1.2  Master02</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;etcd&#x2F;etcd.config.yml</span><br><span class="line">name: &#39;k8s-master02&#39;</span><br><span class="line">data-dir: &#x2F;var&#x2F;lib&#x2F;etcd</span><br><span class="line">wal-dir: &#x2F;var&#x2F;lib&#x2F;etcd&#x2F;wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#39;https:&#x2F;&#x2F;172.20.103.182:2380&#39;</span><br><span class="line">listen-client-urls: &#39;https:&#x2F;&#x2F;172.20.103.182:2379,http:&#x2F;&#x2F;127.0.0.1:2379&#39;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#39;https:&#x2F;&#x2F;172.20.103.182:2380&#39;</span><br><span class="line">advertise-client-urls: &#39;https:&#x2F;&#x2F;172.20.103.182:2379&#39;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#39;proxy&#39;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#39;k8s-master01&#x3D;https:&#x2F;&#x2F;172.20.103.181:2380,k8s-master02&#x3D;https:&#x2F;&#x2F;172.20.103.182:2380,k8s-master03&#x3D;https:&#x2F;&#x2F;172.20.103.183:2380&#39;</span><br><span class="line">initial-cluster-token: &#39;etcd-k8s-cluster&#39;</span><br><span class="line">initial-cluster-state: &#39;new&#39;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#39;off&#39;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem&#39;</span><br><span class="line">  key-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem&#39;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem&#39;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem&#39;</span><br><span class="line">  key-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem&#39;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem&#39;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br></pre></td></tr></table></div></figure>


        <h6 id="5-1-3-Master03"   >
          <a href="#5-1-3-Master03" class="heading-link"><i class="fas fa-link"></i></a>5.1.3  Master03</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;etcd&#x2F;etcd.config.yml</span><br><span class="line">name: &#39;k8s-master03&#39;</span><br><span class="line">data-dir: &#x2F;var&#x2F;lib&#x2F;etcd</span><br><span class="line">wal-dir: &#x2F;var&#x2F;lib&#x2F;etcd&#x2F;wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#39;https:&#x2F;&#x2F;172.20.103.183:2380&#39;</span><br><span class="line">listen-client-urls: &#39;https:&#x2F;&#x2F;172.20.103.183:2379,http:&#x2F;&#x2F;127.0.0.1:2379&#39;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#39;https:&#x2F;&#x2F;172.20.103.183:2380&#39;</span><br><span class="line">advertise-client-urls: &#39;https:&#x2F;&#x2F;172.20.103.183:2379&#39;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#39;proxy&#39;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#39;k8s-master01&#x3D;https:&#x2F;&#x2F;172.20.103.181:2380,k8s-master02&#x3D;https:&#x2F;&#x2F;172.20.103.182:2380,k8s-master03&#x3D;https:&#x2F;&#x2F;172.20.103.183:2380&#39;</span><br><span class="line">initial-cluster-token: &#39;etcd-k8s-cluster&#39;</span><br><span class="line">initial-cluster-state: &#39;new&#39;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#39;off&#39;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem&#39;</span><br><span class="line">  key-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem&#39;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem&#39;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem&#39;</span><br><span class="line">  key-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem&#39;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#39;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem&#39;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br></pre></td></tr></table></div></figure>


        <h6 id="5-1-4-创建Service"   >
          <a href="#5-1-4-创建Service" class="heading-link"><i class="fas fa-link"></i></a>5.1.4  创建Service</h6>
      <p>所有Master节点创建etcd service并启动</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Etcd Service</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;coreos.com&#x2F;etcd&#x2F;docs&#x2F;latest&#x2F;</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;notify</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd --config-file&#x3D;&#x2F;etc&#x2F;etcd&#x2F;etcd.config.yml</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">RestartSec&#x3D;10</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">Alias&#x3D;etcd3.service </span><br></pre></td></tr></table></div></figure>

<p> 所有Master节点创建etcd的证书目录：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</span><br><span class="line">ln -s &#x2F;etc&#x2F;etcd&#x2F;ssl&#x2F;* &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now etcd</span><br></pre></td></tr></table></div></figure>

<p>查看etcd状态：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API&#x3D;3</span><br><span class="line">etcdctl --endpoints&#x3D;&quot;172.20.103.181:2379,172.20.103.182:2379,172.20.103.183:2379&quot; --cacert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-ca.pem --cert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd.pem --key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;etcd-key.pem endpoint status --write-out&#x3D;table</span><br><span class="line"></span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 172.20.103.181:2379 | e5b14038459a91bb |  3.4.13 |   20 kB |     false |      false |        28 |         19 |                 19 |        |</span><br><span class="line">| 172.20.103.182:2379 | 31f5c99f69828895 |  3.4.13 |   20 kB |     false |      false |        28 |         19 |                 19 |        |</span><br><span class="line">| 172.20.103.183:2379 | 2668af6475671e28 |  3.4.13 |   20 kB |      true |      false |        28 |         19 |                 19 |        |</span><br><span class="line">+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>未完待续</p>
<p>参考链接：</p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.kubeasy.com/]" >http://www.kubeasy.com/]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>: </p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://zhho.cn">Hao Zhang</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://zhho.cn/2021/03/24/k8s1-20-0%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/">http://zhho.cn/2021/03/24/k8s1-20-0%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/03/26/zookeeper%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">zookeeper集群部署</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/03/18/Elasticsearch5-6-16%E4%B9%8B%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"><span class="paginator-prev__text">Elasticsearch5.6.16之集群搭建</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">
          1.  基本环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7"><span class="toc-number">2.</span> <span class="toc-text">
          2. 内核升级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text">
          3. 基本组件安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-Docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">
          3.1  Docker安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-K8s%E5%8F%8Aetcd%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">
          3.2  K8s及etcd安装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">4.</span> <span class="toc-text">
          4. 生成证书</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-etcd%E8%AF%81%E4%B9%A6"><span class="toc-number">4.1.</span> <span class="toc-text">
          4.1 etcd证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-k8s%E7%BB%84%E4%BB%B6%E8%AF%81%E4%B9%A6"><span class="toc-number">4.2.</span> <span class="toc-text">
          4.2   k8s组件证书</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Kubernetes%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">
          5. Kubernetes系统组件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-Etcd%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.</span> <span class="toc-text">
          5.1  Etcd配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-1-Master01"><span class="toc-number">5.1.1.</span> <span class="toc-text">
          5.1.1  Master01</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-2-Master02"><span class="toc-number">5.1.2.</span> <span class="toc-text">
          5.1.2  Master02</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-3-Master03"><span class="toc-number">5.1.3.</span> <span class="toc-text">
          5.1.3  Master03</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-4-%E5%88%9B%E5%BB%BAService"><span class="toc-number">5.1.4.</span> <span class="toc-text">
          5.1.4  创建Service</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Meteor across</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">35</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">3</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Hao Zhang</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.1.1</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>