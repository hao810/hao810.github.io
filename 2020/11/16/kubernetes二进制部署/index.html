<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="1. 初始化系统环境       参考链接： [https:&#x2F;&#x2F;www.zhho.cn&#x2F;2020&#x2F;09&#x2F;27&#x2F;Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%82%E5%90%88k8s%E8%BF%90%E8%A1%8C%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83&#x2F;]:  所有服务器时间同步 1">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes 1.18.10 二进制部署">
<meta property="og:url" content="http://zhho.cn/2020/11/16/kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="Hao&#39;s blog">
<meta property="og:description" content="1. 初始化系统环境       参考链接： [https:&#x2F;&#x2F;www.zhho.cn&#x2F;2020&#x2F;09&#x2F;27&#x2F;Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%82%E5%90%88k8s%E8%BF%90%E8%A1%8C%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83&#x2F;]:  所有服务器时间同步 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200908163946396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xqeDE1Mjg=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="article:published_time" content="2020-11-16T02:13:18.000Z">
<meta property="article:modified_time" content="2020-12-01T07:35:29.314Z">
<meta property="article:author" content="Hao Zhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20200908163946396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xqeDE1Mjg=,size_16,color_FFFFFF,t_70#pic_center"><title>kubernetes 1.18.10 二进制部署 | Hao's blog</title><link ref="canonical" href="http://zhho.cn/2020/11/16/kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.1.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hao's blog</div><div class="header-banner-info__subtitle">No pains ,no gains</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">kubernetes 1.18.10 二进制部署</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-11-16</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-12-01</span></span></div></header><div class="post-body">
        <h3 id="1-初始化系统环境"   >
          <a href="#1-初始化系统环境" class="heading-link"><i class="fas fa-link"></i></a>1. 初始化系统环境</h3>
      <p>参考链接：</p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.zhho.cn/2020/09/27/Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%82%E5%90%88k8s%E8%BF%90%E8%A1%8C%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83/]" >https://www.zhho.cn/2020/09/27/Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%82%E5%90%88k8s%E8%BF%90%E8%A1%8C%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83/]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>: </p>
<p>所有服务器时间同步</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntpdate</span><br><span class="line">crontab -e</span><br><span class="line">*&#x2F;5 * * * * &#x2F;usr&#x2F;sbin&#x2F;ntpdate ntp1.aliyun.com;&#x2F;sbin&#x2F;hwclock -w; &amp;&gt;&#x2F;dev&#x2F;null</span><br></pre></td></tr></table></div></figure>

<p>配置hosts主机名解析</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# tail -5 &#x2F;etc&#x2F;hosts</span><br><span class="line">192.168.7.11 k8s-master1</span><br><span class="line">192.168.7.12 k8s-master2</span><br><span class="line">192.168.7.13 k8s-master3</span><br><span class="line">192.168.7.14 k8s-node1</span><br><span class="line">192.168.7.15 k8s-node2</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-部署Etcd集群"   >
          <a href="#2-部署Etcd集群" class="heading-link"><i class="fas fa-link"></i></a>2. 部署Etcd集群</h3>
      <p>Etcd 是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为解决Etcd单点故障，应采用集群方式部署，这里使用3台组建集群，可容忍1台机器故障，当然，你也可以使用5台组建集群，可容忍2台机器故障。</p>
<div class="table-container"><table>
<thead>
<tr>
<th>节点名称</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>etcd-1</td>
<td>192.168.7.11</td>
</tr>
<tr>
<td>etcd-2</td>
<td>192.168.7.12</td>
</tr>
<tr>
<td>etcd-3</td>
<td>192.168.7.13</td>
</tr>
</tbody></table></div>
<p>注：为了节省机器，这里与k8s节点机器复用。也可以独立于k8s集群之外部署，只要apiserver能连接到就行。</p>

        <h4 id="2-1-准备cfssl证书生成工具"   >
          <a href="#2-1-准备cfssl证书生成工具" class="heading-link"><i class="fas fa-link"></i></a>2.1 准备cfssl证书生成工具</h4>
      <p>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用。<br>找任意一台服务器操作，这里用Master1节点。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;root&#x2F;tools </span><br><span class="line">cd &#x2F;root&#x2F;tools</span><br><span class="line">wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl_linux-amd64</span><br><span class="line">wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssljson_linux-amd64</span><br><span class="line">wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssl</span><br><span class="line">mv cfssljson_linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;cfssl-certinfo</span><br></pre></td></tr></table></div></figure>

<a id="more"></a>


        <h4 id="2-2-生成Etcd证书"   >
          <a href="#2-2-生成Etcd证书" class="heading-link"><i class="fas fa-link"></i></a>2.2 生成Etcd证书</h4>
      
        <h5 id="2-2-1自签证书颁发机构（CA）"   >
          <a href="#2-2-1自签证书颁发机构（CA）" class="heading-link"><i class="fas fa-link"></i></a>2.2.1自签证书颁发机构（CA）</h5>
      
        <h6 id="2-2-1-1-创建工作目录："   >
          <a href="#2-2-1-1-创建工作目录：" class="heading-link"><i class="fas fa-link"></i></a>2.2.1.1 创建工作目录：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~&#x2F;TLS&#x2F;&#123;etcd,k8s&#125;</span><br><span class="line">cd TLS&#x2F;etcd</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-2-1-2自签CA："   >
          <a href="#2-2-1-2自签CA：" class="heading-link"><i class="fas fa-link"></i></a>2.2.1.2自签CA：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;www&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>字段说明</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ca-config.json：可以定义多个 profiles，分别指定不同的参数；后续在签名证书时使用某个profile；</span><br><span class="line">signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA&#x3D;TRUE；</span><br><span class="line">server auth：表示client可以用该 CA 对server提供的证书进行验证；</span><br><span class="line">client auth：表示server可以用该CA对client提供的证书进行验证；</span><br><span class="line">profiles 中的 www 是后面cfssl gencert 命令值profiles 指定的值，要相互对应。</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-2-1-3-生成证书："   >
          <a href="#2-2-1-3-生成证书：" class="heading-link"><i class="fas fa-link"></i></a>2.2.1.3 生成证书：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">ls *pem</span><br><span class="line">ca-key.pem  ca.pem</span><br></pre></td></tr></table></div></figure>


        <h5 id="2-2-2-使用自签CA签发Etcd-HTTPS证书"   >
          <a href="#2-2-2-使用自签CA签发Etcd-HTTPS证书" class="heading-link"><i class="fas fa-link"></i></a>2.2.2 使用自签CA签发Etcd HTTPS证书</h5>
      
        <h6 id="2-2-2-1-创建证书申请文件："   >
          <a href="#2-2-2-1-创建证书申请文件：" class="heading-link"><i class="fas fa-link"></i></a>2.2.2.1 创建证书申请文件：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;192.168.7.11&quot;,</span><br><span class="line">    &quot;192.168.7.12&quot;,</span><br><span class="line">    &quot;192.168.7.13&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>注：上述文件hosts字段中IP为所有etcd节点的集群内部通信IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP。</p>

        <h6 id="2-2-2-2-生成证书："   >
          <a href="#2-2-2-2-生成证书：" class="heading-link"><i class="fas fa-link"></i></a>2.2.2.2 生成证书：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;www server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line">ls server*pem</span><br><span class="line">server-key.pem  server.pem</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-3-从Github下载etcd二进制文件并部署"   >
          <a href="#2-3-从Github下载etcd二进制文件并部署" class="heading-link"><i class="fas fa-link"></i></a>2.3 从Github下载etcd二进制文件并部署</h4>
      
        <h5 id="2-3-1-下载etcd二进制文件"   >
          <a href="#2-3-1-下载etcd二进制文件" class="heading-link"><i class="fas fa-link"></i></a>2.3.1 下载etcd二进制文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root&#x2F;tools</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.4.9&#x2F;etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">1</span><br></pre></td></tr></table></div></figure>


        <h5 id="2-3-2-部署Etcd集群"   >
          <a href="#2-3-2-部署Etcd集群" class="heading-link"><i class="fas fa-link"></i></a>2.3.2 部署Etcd集群</h5>
      <p>注：以下在节点1上操作，为简化操作，待会将节点1生成的所有文件拷贝到节点2和节点3.</p>

        <h6 id="2-3-2-1-创建工作目录并解压二进制包"   >
          <a href="#2-3-2-1-创建工作目录并解压二进制包" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.1 创建工作目录并解压二进制包</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;opt&#x2F;etcd&#x2F;&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">tar zxvf etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.4.9-linux-amd64&#x2F;&#123;etcd,etcdctl&#125; &#x2F;opt&#x2F;etcd&#x2F;bin&#x2F;</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-3-2-2-创建etcd配置文件"   >
          <a href="#2-3-2-2-创建etcd配置文件" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.2 创建etcd配置文件</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;etcd&#x2F;cfg&#x2F;etcd.conf &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME&#x3D;&quot;etcd-1&quot;</span><br><span class="line">ETCD_DATA_DIR&#x3D;&quot;&#x2F;var&#x2F;lib&#x2F;etcd&#x2F;default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER&#x3D;&quot;etcd-1&#x3D;https:&#x2F;&#x2F;192.168.7.11:2380,etcd-2&#x3D;https:&#x2F;&#x2F;192.168.7.12:2380,etcd-3&#x3D;https:&#x2F;&#x2F;192.168.7.13:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN&#x3D;&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE&#x3D;&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>字段说明</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ETCD_NAME：节点名称，集群中唯一</span><br><span class="line">ETCD_DATA_DIR：数据目录</span><br><span class="line">ETCD_LISTEN_PEER_URLS：集群通信监听地址</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</span><br><span class="line">ETCD_INITIAL_CLUSTER：集群节点地址</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN：集群Token</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-3-2-3-systemd管理etcd"   >
          <a href="#2-3-2-3-systemd管理etcd" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.3 systemd管理etcd</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Etcd Server</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;notify</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;etcd&#x2F;cfg&#x2F;etcd.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;etcd&#x2F;bin&#x2F;etcd \</span><br><span class="line">--cert-file&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server.pem \</span><br><span class="line">--key-file&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server-key.pem \</span><br><span class="line">--peer-cert-file&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server.pem \</span><br><span class="line">--peer-key-file&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server-key.pem \</span><br><span class="line">--trusted-ca-file&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">--peer-trusted-ca-file&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">--logger&#x3D;zap</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-3-2-4-拷贝刚才生成的证书"   >
          <a href="#2-3-2-4-拷贝刚才生成的证书" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.4 拷贝刚才生成的证书</h6>
      <p>把刚才生成的证书拷贝到配置文件中的路径/opt/etcd/ssl下面</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~&#x2F;TLS&#x2F;etcd&#x2F;ca*pem ~&#x2F;TLS&#x2F;etcd&#x2F;server*pem &#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-3-2-5-将上面节点1所有生成的文件拷贝到节点2和节点3"   >
          <a href="#2-3-2-5-将上面节点1所有生成的文件拷贝到节点2和节点3" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.5 将上面节点1所有生成的文件拷贝到节点2和节点3</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp -r &#x2F;opt&#x2F;etcd&#x2F; root@192.168.7.12:&#x2F;opt&#x2F;</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;etcd.service root@192.168.7.12:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;</span><br><span class="line">scp -r &#x2F;opt&#x2F;etcd&#x2F; root@192.168.7.13:&#x2F;opt&#x2F;</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;etcd.service root@192.168.7.13:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;</span><br></pre></td></tr></table></div></figure>

<p>注：在节点2和节点3分别修改etcd.conf配置文件中的节点名称和当前服务器IP：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;opt&#x2F;etcd&#x2F;cfg&#x2F;etcd.conf</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME&#x3D;&quot;etcd-1&quot;   # 修改此处，节点2改为etcd-2，节点3改为etcd-3</span><br><span class="line">ETCD_DATA_DIR&#x3D;&quot;&#x2F;var&#x2F;lib&#x2F;etcd&#x2F;default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2380&quot;   # 修改此处为当前服务器IP</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2379&quot; # 修改此处为当前服务器IP</span><br><span class="line"></span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2380&quot; # 修改此处为当前服务器IP</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2379&quot; # 修改此处为当前服务器IP</span><br><span class="line">ETCD_INITIAL_CLUSTER&#x3D;&quot;etcd-1&#x3D;https:&#x2F;&#x2F;192.168.7.11:2380,etcd-2&#x3D;https:&#x2F;&#x2F;192.168.7.12:2380,etcd-3&#x3D;https:&#x2F;&#x2F;192.168.7.13:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN&#x3D;&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE&#x3D;&quot;new&quot;</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-3-2-6-所有节点启动etcd并设置开机启动"   >
          <a href="#2-3-2-6-所有节点启动etcd并设置开机启动" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.6 所有节点启动etcd并设置开机启动</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></div></figure>


        <h6 id="2-3-2-7-查看集群状态"   >
          <a href="#2-3-2-7-查看集群状态" class="heading-link"><i class="fas fa-link"></i></a>2.3.2.7 查看集群状态</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API&#x3D;3 &#x2F;opt&#x2F;etcd&#x2F;bin&#x2F;etcdctl --cacert&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;ca.pem --cert&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server.pem --key&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server-key.pem --endpoints&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.11:2379,https:&#x2F;&#x2F;192.168.7.12:2379,https:&#x2F;&#x2F;192.168.7.3:2379&quot; endpoint health</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;192.168.7.11:2379 is healthy: successfully committed proposal: took &#x3D; 16.954243ms</span><br><span class="line">https:&#x2F;&#x2F;192.168.7.12:2379 is healthy: successfully committed proposal: took &#x3D; 21.02197ms</span><br><span class="line">https:&#x2F;&#x2F;192.168.7.13:2379 is healthy: successfully committed proposal: took &#x3D; 22.448277ms</span><br><span class="line"></span><br><span class="line">如果输出上面信息，就说明集群部署成功。如果有问题第一步先看日志：&#x2F;var&#x2F;log&#x2F;message 或 journalctl -u etcd</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-安装Docker"   >
          <a href="#3-安装Docker" class="heading-link"><i class="fas fa-link"></i></a>3. 安装Docker</h3>
      
        <h4 id="3-1-配置docker阿里云yum源进行安装"   >
          <a href="#3-1-配置docker阿里云yum源进行安装" class="heading-link"><i class="fas fa-link"></i></a>3.1 配置docker阿里云yum源进行安装</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;yum.repos.d&#x2F;  &amp;&amp;  wget https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line"></span><br><span class="line">cp &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;completions&#x2F;docker &#x2F;etc&#x2F;bash_completion.d&#x2F;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;etc&#x2F;docker&#x2F;</span><br><span class="line"></span><br><span class="line">cat &gt; &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;],</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;live-restore&quot;: true,</span><br><span class="line">    &quot;max-concurrent-downloads&quot;: 10,</span><br><span class="line">    &quot;max-concurrent-uploads&quot;: 10,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;2lefsjdg.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check&#x3D;true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable --now docker</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-部署Master-Node"   >
          <a href="#4-部署Master-Node" class="heading-link"><i class="fas fa-link"></i></a>4. 部署Master Node</h3>
      
        <h4 id="4-1-生成kube-apiserver证书"   >
          <a href="#4-1-生成kube-apiserver证书" class="heading-link"><i class="fas fa-link"></i></a>4.1 生成kube-apiserver证书</h4>
      
        <h5 id="4-1-1-创建自签证书颁发机构（CA）"   >
          <a href="#4-1-1-创建自签证书颁发机构（CA）" class="heading-link"><i class="fas fa-link"></i></a>4.1.1 创建自签证书颁发机构（CA）</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h6 id="4-1-1-1-生成证书："   >
          <a href="#4-1-1-1-生成证书：" class="heading-link"><i class="fas fa-link"></i></a>4.1.1.1 生成证书：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line">ls *pem</span><br><span class="line">ca-key.pem  ca.pem</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-1-2-使用自签CA签发kube-apiserver-HTTPS证书"   >
          <a href="#4-1-2-使用自签CA签发kube-apiserver-HTTPS证书" class="heading-link"><i class="fas fa-link"></i></a>4.1.2 使用自签CA签发kube-apiserver HTTPS证书</h5>
      
        <h6 id="4-1-2-1-创建证书申请文件："   >
          <a href="#4-1-2-1-创建证书申请文件：" class="heading-link"><i class="fas fa-link"></i></a>4.1.2.1 创建证书申请文件：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cd TLS&#x2F;k8s</span><br><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.0.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.7.11&quot;,</span><br><span class="line">      &quot;192.168.7.12&quot;,</span><br><span class="line">      &quot;192.168.7.13&quot;,</span><br><span class="line">      &quot;192.168.7.14&quot;,</span><br><span class="line">      &quot;192.168.7.15&quot;,</span><br><span class="line">      &quot;192.168.7.16&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>注：上述文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP。</p>

        <h6 id="4-1-2-2-生成证书："   >
          <a href="#4-1-2-2-生成证书：" class="heading-link"><i class="fas fa-link"></i></a>4.1.2.2 生成证书：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line">ls server*pem</span><br><span class="line">server-key.pem  server.pem</span><br></pre></td></tr></table></div></figure>


        <h4 id="4-2-从Github下载kubernetes二进制文件包并解压"   >
          <a href="#4-2-从Github下载kubernetes二进制文件包并解压" class="heading-link"><i class="fas fa-link"></i></a>4.2 从Github下载kubernetes二进制文件包并解压</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下载地址： https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes&#x2F;blob&#x2F;master&#x2F;CHANGELOG&#x2F;CHANGELOG-1.18.md#v1183</span><br></pre></td></tr></table></div></figure>

<p>注：打开链接你会发现里面有很多包，下载一个server包就够了，包含了Master和Worker Node二进制文件。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;tools</span><br><span class="line">wget https:&#x2F;&#x2F;dl.k8s.io&#x2F;v1.18.10&#x2F;kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">mkdir -p &#x2F;opt&#x2F;kubernetes&#x2F;&#123;bin,cfg,ssl,logs&#125; </span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">cp kube-apiserver kube-scheduler kube-controller-manager &#x2F;opt&#x2F;kubernetes&#x2F;bin</span><br><span class="line">cp kubectl &#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></div></figure>


        <h4 id="4-3-部署kube-apiserver"   >
          <a href="#4-3-部署kube-apiserver" class="heading-link"><i class="fas fa-link"></i></a>4.3 部署kube-apiserver</h4>
      
        <h5 id="4-3-1-创建配置文件"   >
          <a href="#4-3-1-创建配置文件" class="heading-link"><i class="fas fa-link"></i></a>4.3.1 创建配置文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS&#x3D;&quot;--logtostderr&#x3D;false \\</span><br><span class="line">--v&#x3D;2 \\</span><br><span class="line">--log-dir&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;logs \\</span><br><span class="line">--etcd-servers&#x3D;https:&#x2F;&#x2F;192.168.7.11:2379,https:&#x2F;&#x2F;192.168.7.12:2379,https:&#x2F;&#x2F;192.168.7.13:2379 \\</span><br><span class="line">--bind-address&#x3D;192.168.7.11 \\</span><br><span class="line">--secure-port&#x3D;6443 \\</span><br><span class="line">--advertise-address&#x3D;192.168.7.11 \\</span><br><span class="line">--allow-privileged&#x3D;true \\</span><br><span class="line">--service-cluster-ip-range&#x3D;10.0.0.0&#x2F;24 \\</span><br><span class="line">--enable-admission-plugins&#x3D;NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode&#x3D;RBAC,Node \\</span><br><span class="line">--enable-bootstrap-token-auth&#x3D;true \\</span><br><span class="line">--token-auth-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;token.csv \\</span><br><span class="line">--service-node-port-range&#x3D;30000-32767 \\</span><br><span class="line">--kubelet-client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server.pem \\</span><br><span class="line">--kubelet-client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server-key.pem \\</span><br><span class="line">--tls-cert-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server.pem  \\</span><br><span class="line">--tls-private-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;server-key.pem \\</span><br><span class="line">--client-ca-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \\</span><br><span class="line">--service-account-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem \\</span><br><span class="line">--etcd-cafile&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;ca.pem \\</span><br><span class="line">--etcd-certfile&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server.pem \\</span><br><span class="line">--etcd-keyfile&#x3D;&#x2F;opt&#x2F;etcd&#x2F;ssl&#x2F;server-key.pem \\</span><br><span class="line">--audit-log-maxage&#x3D;30 \\</span><br><span class="line">--audit-log-maxbackup&#x3D;3 \\</span><br><span class="line">--audit-log-maxsize&#x3D;100 \\</span><br><span class="line">--audit-log-path&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;logs&#x2F;k8s-audit.log&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>注：上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用EOF保留换行符。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">–logtostderr：启用日志</span><br><span class="line">—v：日志等级</span><br><span class="line">–log-dir：日志目录</span><br><span class="line">–etcd-servers：etcd集群地址</span><br><span class="line">–bind-address：监听地址</span><br><span class="line">–secure-port：https安全端口</span><br><span class="line">–advertise-address：集群通告地址</span><br><span class="line">–allow-privileged：启用授权</span><br><span class="line">–service-cluster-ip-range：Service虚拟IP地址段</span><br><span class="line">–enable-admission-plugins：准入控制模块</span><br><span class="line">–authorization-mode：认证授权，启用RBAC授权和节点自管理</span><br><span class="line">–enable-bootstrap-token-auth：启用TLS bootstrap机制</span><br><span class="line">–token-auth-file：bootstrap token文件</span><br><span class="line">–service-node-port-range：Service nodeport类型默认分配端口范围</span><br><span class="line">–kubelet-client-xxx：apiserver访问kubelet客户端证书</span><br><span class="line">–tls-xxx-file：apiserver https证书</span><br><span class="line">–etcd-xxxfile：连接Etcd集群证书</span><br><span class="line">–audit-log-xxx：审计日志</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-3-2-拷贝刚才生成的证书到配置文件中的路径"   >
          <a href="#4-3-2-拷贝刚才生成的证书到配置文件中的路径" class="heading-link"><i class="fas fa-link"></i></a>4.3.2 拷贝刚才生成的证书到配置文件中的路径</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~&#x2F;TLS&#x2F;k8s&#x2F;ca*pem ~&#x2F;TLS&#x2F;k8s&#x2F;server*pem &#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-3-3-启用-TLS-Bootstrapping-机制"   >
          <a href="#4-3-3-启用-TLS-Bootstrapping-机制" class="heading-link"><i class="fas fa-link"></i></a>4.3.3 启用 TLS Bootstrapping 机制</h5>
      <p>TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书。<br>TLS bootstraping 工作流程：<br><img   src="https://img-blog.csdnimg.cn/20200908163946396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xqeDE1Mjg=,size_16,color_FFFFFF,t_70#pic_center" style="width: image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,tepx;height: t_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2px;"  alt="在这里插入图片描述"></p>

        <h6 id="4-3-3-1-创建上述配置文件中token文件："   >
          <a href="#4-3-3-1-创建上述配置文件中token文件：" class="heading-link"><i class="fas fa-link"></i></a>4.3.3.1 创建上述配置文件中token文件：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;token.csv &lt;&lt; EOF</span><br><span class="line">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>格式：token，用户名，UID，用户组<br>token也可自行生成替换：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 &#x2F;dev&#x2F;urandom | od -An -t x | tr -d &#39; &#39;</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-3-4-systemd管理apiserver"   >
          <a href="#4-3-4-systemd管理apiserver" class="heading-link"><i class="fas fa-link"></i></a>4.3.4 systemd管理apiserver</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes API Server</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-apiserver.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-3-5-拷贝节点1-kube-apiserver相关信息到节点2与节点3"   >
          <a href="#4-3-5-拷贝节点1-kube-apiserver相关信息到节点2与节点3" class="heading-link"><i class="fas fa-link"></i></a>4.3.5 拷贝节点1 kube-apiserver相关信息到节点2与节点3</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scp -r &#x2F;opt&#x2F;kubernetes k8s-master2:&#x2F;opt&#x2F;</span><br><span class="line">scp -r &#x2F;opt&#x2F;kubernetes k8s-master3:&#x2F;opt&#x2F;</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service k8s-master2:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service k8s-master3:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service</span><br><span class="line">注意：在节点2与节点3的配置文件修改对应节点的ip</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-3-6-启动所有节点的kube-apiserver并设置开机启动"   >
          <a href="#4-3-6-启动所有节点的kube-apiserver并设置开机启动" class="heading-link"><i class="fas fa-link"></i></a>4.3.6 启动所有节点的kube-apiserver并设置开机启动</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl enable kube-apiserver</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-3-7-授权kubelet-bootstrap用户允许请求证书"   >
          <a href="#4-3-7-授权kubelet-bootstrap用户允许请求证书" class="heading-link"><i class="fas fa-link"></i></a>4.3.7 授权kubelet-bootstrap用户允许请求证书</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole&#x3D;system:node-bootstrapper \</span><br><span class="line">--user&#x3D;kubelet-bootstrap</span><br></pre></td></tr></table></div></figure>


        <h4 id="4-4-部署kube-controller-manager"   >
          <a href="#4-4-部署kube-controller-manager" class="heading-link"><i class="fas fa-link"></i></a>4.4 部署kube-controller-manager</h4>
      
        <h5 id="4-4-1-创建配置文件"   >
          <a href="#4-4-1-创建配置文件" class="heading-link"><i class="fas fa-link"></i></a>4.4.1 创建配置文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS&#x3D;&quot;--logtostderr&#x3D;false \\</span><br><span class="line">--v&#x3D;2 \\</span><br><span class="line">--log-dir&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;logs \\</span><br><span class="line">--leader-elect&#x3D;true \\</span><br><span class="line">--master&#x3D;127.0.0.1:8080 \\</span><br><span class="line">--bind-address&#x3D;127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs&#x3D;true \\</span><br><span class="line">--cluster-cidr&#x3D;10.244.0.0&#x2F;16 \\</span><br><span class="line">--service-cluster-ip-range&#x3D;10.0.0.0&#x2F;24 \\</span><br><span class="line">--cluster-signing-cert-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \\</span><br><span class="line">--cluster-signing-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem  \\</span><br><span class="line">--root-ca-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \\</span><br><span class="line">--service-account-private-key-file&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem \\</span><br><span class="line">--experimental-cluster-signing-duration&#x3D;87600h0m0s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>–master：通过本地非安全本地端口8080连接apiserver。<br>–leader-elect：当该组件启动多个时，自动选举（HA）<br>–cluster-signing-cert-file/–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</p>

        <h5 id="4-4-2-systemd管理controller-manager"   >
          <a href="#4-4-2-systemd管理controller-manager" class="heading-link"><i class="fas fa-link"></i></a>4.4.2 systemd管理controller-manager</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Controller Manager</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-controller-manager.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-4-3-拷贝节点1-kube-controller-manager相关信息到节点2与节点3"   >
          <a href="#4-4-3-拷贝节点1-kube-controller-manager相关信息到节点2与节点3" class="heading-link"><i class="fas fa-link"></i></a>4.4.3 拷贝节点1 kube-controller-manager相关信息到节点2与节点3</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-controller-manager.conf k8s-master2:&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;</span><br><span class="line">scp &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-controller-manager.conf k8s-master3:&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service k8s-master2:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service k8s-master3:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-4-4-所有节点启动kube-controller-manager并设置开机启动"   >
          <a href="#4-4-4-所有节点启动kube-controller-manager并设置开机启动" class="heading-link"><i class="fas fa-link"></i></a>4.4.4 所有节点启动kube-controller-manager并设置开机启动</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl enable kube-controller-manager</span><br></pre></td></tr></table></div></figure>


        <h4 id="4-5-部署kube-scheduler"   >
          <a href="#4-5-部署kube-scheduler" class="heading-link"><i class="fas fa-link"></i></a>4.5 部署kube-scheduler</h4>
      
        <h5 id="4-5-1-创建配置文件"   >
          <a href="#4-5-1-创建配置文件" class="heading-link"><i class="fas fa-link"></i></a>4.5.1 创建配置文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS&#x3D;&quot;--logtostderr&#x3D;false \</span><br><span class="line">--v&#x3D;2 \</span><br><span class="line">--log-dir&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;logs \</span><br><span class="line">--leader-elect \</span><br><span class="line">--master&#x3D;127.0.0.1:8080 \</span><br><span class="line">--bind-address&#x3D;127.0.0.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>–master：通过本地非安全本地端口8080连接apiserver。<br>–leader-elect：当该组件启动多个时，自动选举（HA）</p>

        <h5 id="4-5-2-systemd管理scheduler"   >
          <a href="#4-5-2-systemd管理scheduler" class="heading-link"><i class="fas fa-link"></i></a>4.5.2 systemd管理scheduler</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Scheduler</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-scheduler.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-5-3-节点1-kube-scheduler相关信息到节点2与节点3"   >
          <a href="#4-5-3-节点1-kube-scheduler相关信息到节点2与节点3" class="heading-link"><i class="fas fa-link"></i></a>4.5.3 节点1 kube-scheduler相关信息到节点2与节点3</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-scheduler.conf k8s-master2:&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;</span><br><span class="line">scp &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-scheduler.conf k8s-master3:&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service k8s-master2:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service</span><br><span class="line">scp &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service k8s-master3:&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service</span><br></pre></td></tr></table></div></figure>


        <h5 id="4-5-4-所有节点启动kube-scheduler并设置开机启动"   >
          <a href="#4-5-4-所有节点启动kube-scheduler并设置开机启动" class="heading-link"><i class="fas fa-link"></i></a>4.5.4 所有节点启动kube-scheduler并设置开机启动</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl enable kube-scheduler</span><br></pre></td></tr></table></div></figure>


        <h3 id="5-部署Worker-Node"   >
          <a href="#5-部署Worker-Node" class="heading-link"><i class="fas fa-link"></i></a>5 部署Worker Node</h3>
      
        <h4 id="5-1-创建工作目录并拷贝二进制文件"   >
          <a href="#5-1-创建工作目录并拷贝二进制文件" class="heading-link"><i class="fas fa-link"></i></a>5.1 创建工作目录并拷贝二进制文件</h4>
      
        <h5 id="5-1-1-在所有worker-node创建工作目录："   >
          <a href="#5-1-1-在所有worker-node创建工作目录：" class="heading-link"><i class="fas fa-link"></i></a>5.1.1 在所有worker node创建工作目录：</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;opt&#x2F;kubernetes&#x2F;&#123;bin,cfg,ssl,logs&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-1-2-从master节点拷贝二进制文件："   >
          <a href="#5-1-2-从master节点拷贝二进制文件：" class="heading-link"><i class="fas fa-link"></i></a>5.1.2 从master节点拷贝二进制文件：</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root&#x2F;tools&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">scp kubelet kube-proxy  k8s-node1:&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;</span><br><span class="line">scp kubelet kube-proxy  k8s-node2:&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;</span><br></pre></td></tr></table></div></figure>


        <h4 id="5-2-部署kubelet"   >
          <a href="#5-2-部署kubelet" class="heading-link"><i class="fas fa-link"></i></a>5.2 部署kubelet</h4>
      
        <h5 id="5-2-1-创建配置文件"   >
          <a href="#5-2-1-创建配置文件" class="heading-link"><i class="fas fa-link"></i></a>5.2.1 创建配置文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS&#x3D;&quot;--logtostderr&#x3D;false \\</span><br><span class="line">--v&#x3D;2 \\</span><br><span class="line">--log-dir&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;logs \\</span><br><span class="line">--hostname-override&#x3D;k8s-node1 \\</span><br><span class="line">--network-plugin&#x3D;cni \\</span><br><span class="line">--kubeconfig&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;bootstrap.kubeconfig \\</span><br><span class="line">--config&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kubelet-config.yml \\</span><br><span class="line">--cert-dir&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl \\</span><br><span class="line">--pod-infra-container-image&#x3D;registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers&#x2F;pause-amd64:3.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p>–hostname-override：显示名称，集群中唯一<br>–network-plugin：启用CNI<br>–kubeconfig：空路径，会自动生成，后面用于连接apiserver<br>–bootstrap-kubeconfig：首次启动向apiserver申请证书<br>–config：配置参数文件<br>–cert-dir：kubelet证书生成目录<br>–pod-infra-container-image：管理Pod网络容器的镜像</p>

        <h5 id="5-2-2-配置参数文件"   >
          <a href="#5-2-2-配置参数文件" class="heading-link"><i class="fas fa-link"></i></a>5.2.2 配置参数文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kubelet-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io&#x2F;v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.0.0.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: &#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-2-3-生成bootstrap-kubeconfig文件"   >
          <a href="#5-2-3-生成bootstrap-kubeconfig文件" class="heading-link"><i class="fas fa-link"></i></a>5.2.3 生成bootstrap.kubeconfig文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.16:8443&quot; # apiserver IP:PORT</span><br><span class="line">TOKEN&#x3D;&quot;c47ffb939f5ca36231d9e3121a252940&quot; # 与token.csv里保持一致</span><br><span class="line"></span><br><span class="line"># 生成 kubelet bootstrap kubeconfig 配置文件</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig&#x3D;bootstrap.kubeconfig</span><br><span class="line">kubectl config set-credentials &quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --token&#x3D;$&#123;TOKEN&#125; \</span><br><span class="line">  --kubeconfig&#x3D;bootstrap.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;&quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --kubeconfig&#x3D;bootstrap.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig&#x3D;bootstrap.kubeconfig</span><br></pre></td></tr></table></div></figure>

<p>拷贝到配置文件路径：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp bootstrap.kubeconfig &#x2F;opt&#x2F;kubernetes&#x2F;cfg</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-2-4-systemd管理kubelet"   >
          <a href="#5-2-4-systemd管理kubelet" class="heading-link"><i class="fas fa-link"></i></a>5.2.4 systemd管理kubelet</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Kubelet</span><br><span class="line">After&#x3D;docker.service</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kubelet.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;kubelet \$KUBELET_OPTS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-2-5-启动并设置开机启动"   >
          <a href="#5-2-5-启动并设置开机启动" class="heading-link"><i class="fas fa-link"></i></a>5.2.5 启动并设置开机启动</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></div></figure>


        <h4 id="5-3-批准kubelet证书申请并加入集群"   >
          <a href="#5-3-批准kubelet证书申请并加入集群" class="heading-link"><i class="fas fa-link"></i></a>5.3 批准kubelet证书申请并加入集群</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看kubelet证书请求</span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-fYL006u6tQlmuoM0rPwIcQZC8g-vRNinWHs1j7sIzJg   6m3s   kubernetes.io&#x2F;kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"># 批准申请</span><br><span class="line">kubectl certificate approve node-csr-fYL006u6tQlmuoM0rPwIcQZC8g-vRNinWHs1j7sIzJg</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">kubectl get node</span><br><span class="line">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-node1   NotReady   &lt;none&gt;   2m20s   v1.18.10</span><br></pre></td></tr></table></div></figure>

<p>注：由于网络插件还没有部署，节点会没有准备就绪 NotReady</p>

        <h4 id="5-4-部署kube-proxy"   >
          <a href="#5-4-部署kube-proxy" class="heading-link"><i class="fas fa-link"></i></a>5.4 部署kube-proxy</h4>
      
        <h5 id="5-4-1-创建配置文件"   >
          <a href="#5-4-1-创建配置文件" class="heading-link"><i class="fas fa-link"></i></a>5.4.1 创建配置文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS&#x3D;&quot;--logtostderr&#x3D;false \\</span><br><span class="line">--v&#x3D;2 \\</span><br><span class="line">--log-dir&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;logs \\</span><br><span class="line">--config&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-proxy-config.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-4-2-配置参数文件"   >
          <a href="#5-4-2-配置参数文件" class="heading-link"><i class="fas fa-link"></i></a>5.4.2 配置参数文件</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-proxy-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io&#x2F;v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: k8s-node1</span><br><span class="line">clusterCIDR: 10.0.0.0&#x2F;24</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-4-3-生成kube-proxy-kubeconfig文件"   >
          <a href="#5-4-3-生成kube-proxy-kubeconfig文件" class="heading-link"><i class="fas fa-link"></i></a>5.4.3 生成kube-proxy.kubeconfig文件</h5>
      
        <h6 id="5-4-3-1-生成kube-proxy证书："   >
          <a href="#5-4-3-1-生成kube-proxy证书：" class="heading-link"><i class="fas fa-link"></i></a>5.4.3.1 生成kube-proxy证书：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 切换工作目录</span><br><span class="line">cd TLS&#x2F;k8s</span><br><span class="line"></span><br><span class="line"># 创建证书请求文件</span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"></span><br><span class="line">ls kube-proxy*pem</span><br><span class="line">kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></div></figure>


        <h6 id="5-4-3-2-生成kubeconfig文件："   >
          <a href="#5-4-3-2-生成kubeconfig文件：" class="heading-link"><i class="fas fa-link"></i></a>5.4.3.2 生成kubeconfig文件：</h6>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER&#x3D;&quot;https:&#x2F;&#x2F;192.168.7.16:8443&quot;</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;kube-proxy.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;ssl&#x2F;kube-proxy-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;kube-proxy \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></div></figure>

<p>拷贝到配置文件指定路径：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp kube-proxy.kubeconfig &#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-4-4-systemd管理kube-proxy"   >
          <a href="#5-4-4-systemd管理kube-proxy" class="heading-link"><i class="fas fa-link"></i></a>5.4.4 systemd管理kube-proxy</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Proxy</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;cfg&#x2F;kube-proxy.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;bin&#x2F;kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


        <h5 id="5-4-5-启动并设置开机启动"   >
          <a href="#5-4-5-启动并设置开机启动" class="heading-link"><i class="fas fa-link"></i></a>5.4.5 启动并设置开机启动</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl enable kube-proxy</span><br></pre></td></tr></table></div></figure></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://zhho.cn">Hao Zhang</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://zhho.cn/2020/11/16/kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/">http://zhho.cn/2020/11/16/kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/12/01/haproxy%E5%AE%9E%E7%8E%B0%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81-cookie/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">haproxy实现会话保持:cookie</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2020/11/12/%E9%83%A8%E7%BD%B2harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"><span class="paginator-prev__text">部署harbor私有仓库</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">
          1. 初始化系统环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%83%A8%E7%BD%B2Etcd%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">
          2. 部署Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%87%86%E5%A4%87cfssl%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7"><span class="toc-number">2.1.</span> <span class="toc-text">
          2.1 准备cfssl证书生成工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E7%94%9F%E6%88%90Etcd%E8%AF%81%E4%B9%A6"><span class="toc-number">2.2.</span> <span class="toc-text">
          2.2 生成Etcd证书</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6%E9%A2%81%E5%8F%91%E6%9C%BA%E6%9E%84%EF%BC%88CA%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          2.2.1自签证书颁发机构（CA）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1-1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%EF%BC%9A"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">
          2.2.1.1 创建工作目录：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1-2%E8%87%AA%E7%AD%BECA%EF%BC%9A"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">
          2.2.1.2自签CA：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1-3-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%EF%BC%9A"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">
          2.2.1.3 生成证书：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BECA%E7%AD%BE%E5%8F%91Etcd-HTTPS%E8%AF%81%E4%B9%A6"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          2.2.2 使用自签CA签发Etcd HTTPS证书</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-1-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">
          2.2.2.1 创建证书申请文件：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-2-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%EF%BC%9A"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">
          2.2.2.2 生成证书：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E4%BB%8EGithub%E4%B8%8B%E8%BD%BDetcd%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%B9%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">2.3.</span> <span class="toc-text">
          2.3 从Github下载etcd二进制文件并部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E4%B8%8B%E8%BD%BDetcd%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.1.</span> <span class="toc-text">
          2.3.1 下载etcd二进制文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E9%83%A8%E7%BD%B2Etcd%E9%9B%86%E7%BE%A4"><span class="toc-number">2.3.2.</span> <span class="toc-text">
          2.3.2 部署Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E5%B9%B6%E8%A7%A3%E5%8E%8B%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">
          2.3.2.1 创建工作目录并解压二进制包</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-2-%E5%88%9B%E5%BB%BAetcd%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">
          2.3.2.2 创建etcd配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-3-systemd%E7%AE%A1%E7%90%86etcd"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">
          2.3.2.3 systemd管理etcd</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-4-%E6%8B%B7%E8%B4%9D%E5%88%9A%E6%89%8D%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">
          2.3.2.4 拷贝刚才生成的证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-5-%E5%B0%86%E4%B8%8A%E9%9D%A2%E8%8A%82%E7%82%B91%E6%89%80%E6%9C%89%E7%94%9F%E6%88%90%E7%9A%84%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E5%88%B0%E8%8A%82%E7%82%B92%E5%92%8C%E8%8A%82%E7%82%B93"><span class="toc-number">2.3.2.5.</span> <span class="toc-text">
          2.3.2.5 将上面节点1所有生成的文件拷贝到节点2和节点3</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-6-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8etcd%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">2.3.2.6.</span> <span class="toc-text">
          2.3.2.6 所有节点启动etcd并设置开机启动</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-7-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">2.3.2.7.</span> <span class="toc-text">
          2.3.2.7 查看集群状态</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85Docker"><span class="toc-number">3.</span> <span class="toc-text">
          3. 安装Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E9%85%8D%E7%BD%AEdocker%E9%98%BF%E9%87%8C%E4%BA%91yum%E6%BA%90%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">
          3.1 配置docker阿里云yum源进行安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%83%A8%E7%BD%B2Master-Node"><span class="toc-number">4.</span> <span class="toc-text">
          4. 部署Master Node</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E7%94%9F%E6%88%90kube-apiserver%E8%AF%81%E4%B9%A6"><span class="toc-number">4.1.</span> <span class="toc-text">
          4.1 生成kube-apiserver证书</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6%E9%A2%81%E5%8F%91%E6%9C%BA%E6%9E%84%EF%BC%88CA%EF%BC%89"><span class="toc-number">4.1.1.</span> <span class="toc-text">
          4.1.1 创建自签证书颁发机构（CA）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1-1-1-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%EF%BC%9A"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">
          4.1.1.1 生成证书：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-%E4%BD%BF%E7%94%A8%E8%87%AA%E7%AD%BECA%E7%AD%BE%E5%8F%91kube-apiserver-HTTPS%E8%AF%81%E4%B9%A6"><span class="toc-number">4.1.2.</span> <span class="toc-text">
          4.1.2 使用自签CA签发kube-apiserver HTTPS证书</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1-2-1-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">
          4.1.2.1 创建证书申请文件：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1-2-2-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%EF%BC%9A"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">
          4.1.2.2 生成证书：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E4%BB%8EGithub%E4%B8%8B%E8%BD%BDkubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%8C%85%E5%B9%B6%E8%A7%A3%E5%8E%8B"><span class="toc-number">4.2.</span> <span class="toc-text">
          4.2 从Github下载kubernetes二进制文件包并解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E9%83%A8%E7%BD%B2kube-apiserver"><span class="toc-number">4.3.</span> <span class="toc-text">
          4.3 部署kube-apiserver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-1-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.1.</span> <span class="toc-text">
          4.3.1 创建配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-2-%E6%8B%B7%E8%B4%9D%E5%88%9A%E6%89%8D%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E5%88%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84"><span class="toc-number">4.3.2.</span> <span class="toc-text">
          4.3.2 拷贝刚才生成的证书到配置文件中的路径</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-3-%E5%90%AF%E7%94%A8-TLS-Bootstrapping-%E6%9C%BA%E5%88%B6"><span class="toc-number">4.3.3.</span> <span class="toc-text">
          4.3.3 启用 TLS Bootstrapping 机制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-3-1-%E5%88%9B%E5%BB%BA%E4%B8%8A%E8%BF%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%ADtoken%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">
          4.3.3.1 创建上述配置文件中token文件：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-4-systemd%E7%AE%A1%E7%90%86apiserver"><span class="toc-number">4.3.4.</span> <span class="toc-text">
          4.3.4 systemd管理apiserver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-5-%E6%8B%B7%E8%B4%9D%E8%8A%82%E7%82%B91-kube-apiserver%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B92%E4%B8%8E%E8%8A%82%E7%82%B93"><span class="toc-number">4.3.5.</span> <span class="toc-text">
          4.3.5 拷贝节点1 kube-apiserver相关信息到节点2与节点3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-6-%E5%90%AF%E5%8A%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E7%9A%84kube-apiserver%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">4.3.6.</span> <span class="toc-text">
          4.3.6 启动所有节点的kube-apiserver并设置开机启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-7-%E6%8E%88%E6%9D%83kubelet-bootstrap%E7%94%A8%E6%88%B7%E5%85%81%E8%AE%B8%E8%AF%B7%E6%B1%82%E8%AF%81%E4%B9%A6"><span class="toc-number">4.3.7.</span> <span class="toc-text">
          4.3.7 授权kubelet-bootstrap用户允许请求证书</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E9%83%A8%E7%BD%B2kube-controller-manager"><span class="toc-number">4.4.</span> <span class="toc-text">
          4.4 部署kube-controller-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-1-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.1.</span> <span class="toc-text">
          4.4.1 创建配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-2-systemd%E7%AE%A1%E7%90%86controller-manager"><span class="toc-number">4.4.2.</span> <span class="toc-text">
          4.4.2 systemd管理controller-manager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-3-%E6%8B%B7%E8%B4%9D%E8%8A%82%E7%82%B91-kube-controller-manager%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B92%E4%B8%8E%E8%8A%82%E7%82%B93"><span class="toc-number">4.4.3.</span> <span class="toc-text">
          4.4.3 拷贝节点1 kube-controller-manager相关信息到节点2与节点3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8kube-controller-manager%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">4.4.4.</span> <span class="toc-text">
          4.4.4 所有节点启动kube-controller-manager并设置开机启动</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E9%83%A8%E7%BD%B2kube-scheduler"><span class="toc-number">4.5.</span> <span class="toc-text">
          4.5 部署kube-scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-1-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.1.</span> <span class="toc-text">
          4.5.1 创建配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-2-systemd%E7%AE%A1%E7%90%86scheduler"><span class="toc-number">4.5.2.</span> <span class="toc-text">
          4.5.2 systemd管理scheduler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-3-%E8%8A%82%E7%82%B91-kube-scheduler%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E5%88%B0%E8%8A%82%E7%82%B92%E4%B8%8E%E8%8A%82%E7%82%B93"><span class="toc-number">4.5.3.</span> <span class="toc-text">
          4.5.3 节点1 kube-scheduler相关信息到节点2与节点3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8kube-scheduler%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">4.5.4.</span> <span class="toc-text">
          4.5.4 所有节点启动kube-scheduler并设置开机启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%83%A8%E7%BD%B2Worker-Node"><span class="toc-number">5.</span> <span class="toc-text">
          5 部署Worker Node</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E5%B9%B6%E6%8B%B7%E8%B4%9D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.</span> <span class="toc-text">
          5.1 创建工作目录并拷贝二进制文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1-%E5%9C%A8%E6%89%80%E6%9C%89worker-node%E5%88%9B%E5%BB%BA%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%EF%BC%9A"><span class="toc-number">5.1.1.</span> <span class="toc-text">
          5.1.1 在所有worker node创建工作目录：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2-%E4%BB%8Emaster%E8%8A%82%E7%82%B9%E6%8B%B7%E8%B4%9D%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">5.1.2.</span> <span class="toc-text">
          5.1.2 从master节点拷贝二进制文件：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E9%83%A8%E7%BD%B2kubelet"><span class="toc-number">5.2.</span> <span class="toc-text">
          5.2 部署kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.1.</span> <span class="toc-text">
          5.2.1 创建配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.2.</span> <span class="toc-text">
          5.2.2 配置参数文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-3-%E7%94%9F%E6%88%90bootstrap-kubeconfig%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.3.</span> <span class="toc-text">
          5.2.3 生成bootstrap.kubeconfig文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-4-systemd%E7%AE%A1%E7%90%86kubelet"><span class="toc-number">5.2.4.</span> <span class="toc-text">
          5.2.4 systemd管理kubelet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-5-%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">5.2.5.</span> <span class="toc-text">
          5.2.5 启动并设置开机启动</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E6%89%B9%E5%87%86kubelet%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7%E5%B9%B6%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="toc-number">5.3.</span> <span class="toc-text">
          5.3 批准kubelet证书申请并加入集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E9%83%A8%E7%BD%B2kube-proxy"><span class="toc-number">5.4.</span> <span class="toc-text">
          5.4 部署kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.1.</span> <span class="toc-text">
          5.4.1 创建配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.2.</span> <span class="toc-text">
          5.4.2 配置参数文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-3-%E7%94%9F%E6%88%90kube-proxy-kubeconfig%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.3.</span> <span class="toc-text">
          5.4.3 生成kube-proxy.kubeconfig文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-4-3-1-%E7%94%9F%E6%88%90kube-proxy%E8%AF%81%E4%B9%A6%EF%BC%9A"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">
          5.4.3.1 生成kube-proxy证书：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-4-3-2-%E7%94%9F%E6%88%90kubeconfig%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">
          5.4.3.2 生成kubeconfig文件：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-4-systemd%E7%AE%A1%E7%90%86kube-proxy"><span class="toc-number">5.4.4.</span> <span class="toc-text">
          5.4.4 systemd管理kube-proxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-5-%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">5.4.5.</span> <span class="toc-text">
          5.4.5 启动并设置开机启动</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Meteor across</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">27</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">2</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Hao Zhang</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.1.1</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>