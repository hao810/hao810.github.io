<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="不得不说的kubeadm       kubeadm部署很方便,但是是一个老外写的,使用staticPod(容器)运行的管理组件,镜像都是gcr.io域名仓库里的。域名仓库很多docker的人甚至都不知道,docker镜像命名规则是域名&#x2F;库名&#x2F;img_name:tag这种形式,dockerhub上要拉取镜像直接是库名&#x2F;img_name:tag这种名字,是因">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s-network-cilium 搭建kubernetes集群">
<meta property="og:url" content="http://zhho.cn/2020/09/24/k8s-network-cilium/index.html">
<meta property="og:site_name" content="Hao&#39;s blog">
<meta property="og:description" content="不得不说的kubeadm       kubeadm部署很方便,但是是一个老外写的,使用staticPod(容器)运行的管理组件,镜像都是gcr.io域名仓库里的。域名仓库很多docker的人甚至都不知道,docker镜像命名规则是域名&#x2F;库名&#x2F;img_name:tag这种形式,dockerhub上要拉取镜像直接是库名&#x2F;img_name:tag这种名字,是因">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/svg/1176682/1593953281781-d132c23b-e537-4d74-80a4-6faf89bd7801.svg#align=left&display=inline&height=510&margin=%5Bobject%20Object%5D&name=k8s.svg&originHeight=150&originWidth=218&size=85958&status=done&style=none&width=741">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594196209080-1a691d50-bd6d-4f77-a304-1d1b3155b109.png#align=left&display=inline&height=103&margin=%5Bobject%20Object%5D&name=image.png&originHeight=206&originWidth=1219&size=37152&status=done&style=none&width=609.5">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594196465931-fc7cf374-a5ef-4913-8ab6-746b708253f0.png#align=left&display=inline&height=46&margin=%5Bobject%20Object%5D&name=image.png&originHeight=92&originWidth=550&size=9538&status=done&style=none&width=275">
<meta property="og:image" content="https://raw.githubusercontent.com/tangwei0928/picture01/master/20200104211718.png#align=left&display=inline&height=121&margin=%5Bobject%20Object%5D&originHeight=121&originWidth=702&status=done&style=none&width=702">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594439952860-de4aecf8-5f2b-4062-b6b4-750bf81bdccc.png#align=left&display=inline&height=106&margin=%5Bobject%20Object%5D&name=image.png&originHeight=106&originWidth=491&size=7265&status=done&style=none&width=491">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1593015648865-aa8e2229-aa2e-41ff-bf50-7d9dbad7d1ae.png#align=left&display=inline&height=334&margin=%5Bobject%20Object%5D&name=image.png&originHeight=334&originWidth=1075&size=30776&status=done&style=none&width=1075">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1593015747647-1c5d6eee-a8cb-47b1-8aed-eb97ad54dd19.png#align=left&display=inline&height=320&margin=%5Bobject%20Object%5D&name=image.png&originHeight=320&originWidth=972&size=29352&status=done&style=none&width=972">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594448142087-820ba694-af0a-46cf-af10-f07ad6cdf568.png#align=left&display=inline&height=305&margin=%5Bobject%20Object%5D&name=image.png&originHeight=305&originWidth=461&size=14334&status=done&style=none&width=461">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594451204489-5078f6fb-54fe-4afc-a63b-acd44961ee88.png#align=left&display=inline&height=1040&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1040&originWidth=1920&size=276479&status=done&style=none&width=1920">
<meta property="article:published_time" content="2020-09-24T08:22:37.000Z">
<meta property="article:modified_time" content="2020-09-24T08:24:25.977Z">
<meta property="article:author" content="Hao Zhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/svg/1176682/1593953281781-d132c23b-e537-4d74-80a4-6faf89bd7801.svg#align=left&display=inline&height=510&margin=%5Bobject%20Object%5D&name=k8s.svg&originHeight=150&originWidth=218&size=85958&status=done&style=none&width=741"><title>k8s-network-cilium 搭建kubernetes集群 | Hao's blog</title><link ref="canonical" href="http://zhho.cn/2020/09/24/k8s-network-cilium/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.1.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hao's blog</div><div class="header-banner-info__subtitle">No pains ,no gains</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">k8s-network-cilium 搭建kubernetes集群</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-09-24</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-09-24</span></span></div></header><div class="post-body"><p><a name="6ed7c9be"></a></p>

        <h2 id="不得不说的kubeadm"   >
          <a href="#不得不说的kubeadm" class="heading-link"><i class="fas fa-link"></i></a>不得不说的kubeadm</h2>
      <p><br />kubeadm部署很方便,但是是一个老外写的,使用staticPod(容器)运行的管理组件,镜像都是<code>gcr.io</code>域名仓库里的。<br />域名仓库很多docker的人甚至都不知道,docker镜像命名规则是<code>域名/库名/img_name:tag</code>这种形式,dockerhub上要拉取镜像直接是<code>库名/img_name:tag</code>这种名字,是因为域名缺省是<code>docker.io</code>也就是dockerhub上看到的都是这个域名仓库的<br />常见的域名仓库国外有gcr.io,quay.io,国内的阿里(registry.cn-hangzhou.aliyuncs.com,hangzhou以外还有shenzhen啥的),daocloud.io等等.gcr.io因为位置在国外会拉取不到.国内阿里仓库同步了<code>gcr.io/google_containers</code>这些镜像,<br /><br><br />总有人认为kubeadm的容器运行没有二进制运行放心.容器本身就是个隔离受限的进程,另外管理组件都是无状态的,但是他们总感觉不放心。<br />事实上除了kubelet以外所有组件都可以用容器方式运行,管理组件简单说下就是集群数据存放<code>etcd</code>数据库里,apiserver去和etcd交互,其他组件和apiserver交互,kubelet调用api去操作docker,其中一些组件也会去操作各个节点的系统设置<br />ererere<br><a name="ofRxy"></a></p>
<a id="more"></a>

        <h2 id="架构"   >
          <a href="#架构" class="heading-link"><i class="fas fa-link"></i></a>架构</h2>
      <p>三个master，多个node。<br />kube-proxy开启ipvs模式通信。<br />所有组件都得与kube-apiserver通信，这边在每台主机部署nginx容器，将kube-apiserver的访问代理到后端三个master上的kube-apiserver pod中去，实现master高可用。<br /><img src="https://cdn.nlark.com/yuque/0/2020/svg/1176682/1593953281781-d132c23b-e537-4d74-80a4-6faf89bd7801.svg#align=left&display=inline&height=510&margin=%5Bobject%20Object%5D&name=k8s.svg&originHeight=150&originWidth=218&size=85958&status=done&style=none&width=741" alt="k8s.svg"><br><a name="F1kUn"></a></p>

        <h3 id="master的组件"   >
          <a href="#master的组件" class="heading-link"><i class="fas fa-link"></i></a>master的组件</h3>
      <ul>
<li><p>etcd</p>
</li>
<li><p>kube-apiserver</p>
</li>
<li><p>kube-controller-manager</p>
</li>
<li><p>kube-scheduler</p>
</li>
<li><p>kubelet</p>
</li>
<li><p>kube-proxy</p>
</li>
<li><p>docker</p>
</li>
<li><p>nginx<br><a name="JNO39"></a></p>

        <h3 id="node的组件"   >
          <a href="#node的组件" class="heading-link"><i class="fas fa-link"></i></a>node的组件</h3>
      </li>
<li><p>kubelet</p>
</li>
<li><p>kube-proxy</p>
</li>
<li><p>docker</p>
</li>
<li><p>nginx</p>
</li>
</ul>
<p><a name="cbb060fd"></a></p>

        <h2 id="环境准备"   >
          <a href="#环境准备" class="heading-link"><i class="fas fa-link"></i></a>环境准备</h2>
      <p><br />在所有节点操作<br /></p>
<p><a name="e272bcd2"></a></p>

        <h3 id="所有主机统一hosts"   >
          <a href="#所有主机统一hosts" class="heading-link"><i class="fas fa-link"></i></a>所有主机统一hosts</h3>
      <p>hosts统一如下<br />系统<code>CentOS 7.6+</code>以上，最好不要使用centos7.5以下，容器技术依赖于内核技术，低版本系统部署和运行后可能问题会非常多。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;hosts</span><br><span class="line"></span><br><span class="line">127.0.0.1 apiserver.k8s.local</span><br><span class="line">192.168.33.101 master01</span><br><span class="line">192.168.33.102 master02</span><br><span class="line">192.168.33.103 master03</span><br><span class="line">192.168.33.201 node01</span><br><span class="line">192.168.33.202 node02</span><br><span class="line">192.168.33.203 node03</span><br></pre></td></tr></table></div></figure>
<div class="table-container"><table>
<thead>
<tr>
<th align="left">IP</th>
<th align="center">Hostname</th>
<th align="center">内核</th>
<th align="center">CPU</th>
<th align="center">Memory</th>
</tr>
</thead>
<tbody><tr>
<td align="left">192.168.33.101</td>
<td align="center">master01</td>
<td align="center">3.10.0-1062</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
<tr>
<td align="left">192.168.33.102</td>
<td align="center">master02</td>
<td align="center">3.10.0-1062</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
<tr>
<td align="left">192.168.33.103</td>
<td align="center">master03</td>
<td align="center">3.10.0-1062</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
<tr>
<td align="left">192.168.33.201</td>
<td align="center">node01</td>
<td align="center">3.10.0-1062</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
<tr>
<td align="left">192.168.33.202</td>
<td align="center">node02</td>
<td align="center">3.10.0-1062</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
<tr>
<td align="left">192.168.33.203</td>
<td align="center">node03</td>
<td align="center">3.10.0-1062</td>
<td align="center">2</td>
<td align="center">4G</td>
</tr>
</tbody></table></div>
<ul>
<li>kubeadm好像要求最低配置2c2g还是多少来着，越高越好</li>
<li>所有操作全部用root使用者进行，系统盘根目录一定要大，不然到时候镜像多了例如到了85%会被gc回收镜像</li>
<li>高可用一般建议大于等于3台的奇数台,使用3台<code>master</code>来做高可用</li>
</ul>
<p><a name="BD1XW"></a></p>

        <h3 id="所有机器升级内核（可选）"   >
          <a href="#所有机器升级内核（可选）" class="heading-link"><i class="fas fa-link"></i></a>所有机器升级内核（可选）</h3>
      <p>导入升级内核的yum源</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https:&#x2F;&#x2F;www.elrepo.org&#x2F;RPM-GPG-KEY-elrepo.org</span><br><span class="line">rpm -Uvh http:&#x2F;&#x2F;www.elrepo.org&#x2F;elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br></pre></td></tr></table></div></figure>
<p>查看可用版本 kernel-lt指长期稳定版 kernel-ml指最新版</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo&#x3D;&quot;*&quot; --enablerepo&#x3D;&quot;elrepo-kernel&quot; list available</span><br></pre></td></tr></table></div></figure>
<p>安装kernel-ml</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --enablerepo&#x3D;elrepo-kernel install kernel-ml kernel-ml-devel -y</span><br></pre></td></tr></table></div></figure>
<p><a name="R2POd"></a></p>

        <h4 id="设置启动项"   >
          <a href="#设置启动项" class="heading-link"><i class="fas fa-link"></i></a>设置启动项</h4>
      <p>查看系统上的所有可用内核</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F\&#39; &#39;$1&#x3D;&#x3D;&quot;menuentry &quot; &#123;print i++ &quot; : &quot; $2&#125;&#39; &#x2F;etc&#x2F;grub2.cfg</span><br></pre></td></tr></table></div></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594196209080-1a691d50-bd6d-4f77-a304-1d1b3155b109.png#align=left&display=inline&height=103&margin=%5Bobject%20Object%5D&name=image.png&originHeight=206&originWidth=1219&size=37152&status=done&style=none&width=609.5" alt="image.png"><br />设置新的内核为grub2的默认版本</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-set-default &#39;CentOS Linux (5.7.7-1.el7.elrepo.x86_64) 7 (Core)&#39;</span><br></pre></td></tr></table></div></figure>

<p><br />生成 grub 配置文件并重启</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o &#x2F;boot&#x2F;grub2&#x2F;grub.cfg</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></div></figure>

<p><br />重启后</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></div></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594196465931-fc7cf374-a5ef-4913-8ab6-746b708253f0.png#align=left&display=inline&height=46&margin=%5Bobject%20Object%5D&name=image.png&originHeight=92&originWidth=550&size=9538&status=done&style=none&width=275" alt="image.png"><br><a name="17cc97ce"></a></p>

        <h3 id="所有机器都关闭防火墙，swap，selinux"   >
          <a href="#所有机器都关闭防火墙，swap，selinux" class="heading-link"><i class="fas fa-link"></i></a>所有机器都关闭防火墙，swap，selinux</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#关闭防火墙</span><br><span class="line">systemctl disable --now firewalld NetworkManager</span><br><span class="line"></span><br><span class="line">#关闭swap</span><br><span class="line">swapoff -a</span><br><span class="line">sed -ri &#39;&#x2F;^[^#]*swap&#x2F;s@^@#@&#39; &#x2F;etc&#x2F;fstab</span><br><span class="line"></span><br><span class="line">#关闭selinux</span><br><span class="line">setenforce 0</span><br><span class="line">sed -ri &#39;&#x2F;^[^#]*SELINUX&#x3D;&#x2F;s#&#x3D;.+$#&#x3D;disabled#&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br></pre></td></tr></table></div></figure>


<p><a name="7b3ef209"></a></p>

        <h3 id="所有机器yum准备"   >
          <a href="#所有机器yum准备" class="heading-link"><i class="fas fa-link"></i></a>所有机器yum准备</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line"></span><br><span class="line">yum update -y</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install  gcc bc gcc-c++ ncurses ncurses-devel cmake elfutils-libelf-devel openssl-devel flex* bison* autoconf automake zlib* fiex* libxml* ncurses-devel libmcrypt* libtool-ltdl-devel* make cmake  pcre pcre-devel openssl openssl-devel   jemalloc-devel tlc libtool vim unzip wget lrzsz bash-comp* ipvsadm ipset jq sysstat conntrack libseccomp conntrack-tools socat curl wget git conntrack-tools psmisc nfs-utils tree bash-completion conntrack libseccomp net-tools crontabs sysstat iftop nload strace bind-utils tcpdump htop telnet lsof </span><br></pre></td></tr></table></div></figure>
<p><a name="21d411b7"></a></p>

        <h3 id="所有机器都加载ipvs"   >
          <a href="#所有机器都加载ipvs" class="heading-link"><i class="fas fa-link"></i></a>所有机器都加载ipvs</h3>
      <p>内核4.19及4.19以上的用这个ipvs配置文件</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">:&gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf</span><br><span class="line">module&#x3D;(</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">br_netfilter</span><br><span class="line">  )</span><br><span class="line">for kernel_module in $&#123;module[@]&#125;;do</span><br><span class="line">    &#x2F;sbin&#x2F;modinfo -F filename $kernel_module |&amp; grep -qv ERROR &amp;&amp; echo $kernel_module &gt;&gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf || :</span><br><span class="line">done</span><br></pre></td></tr></table></div></figure>

<p><br />内核4.19以下的，不包括4.19，用这个ipvs配置文件</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">:&gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf</span><br><span class="line">module&#x3D;(</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack_ipv4</span><br><span class="line">br_netfilter</span><br><span class="line">  )</span><br><span class="line">for kernel_module in $&#123;module[@]&#125;;do</span><br><span class="line">    &#x2F;sbin&#x2F;modinfo -F filename $kernel_module |&amp; grep -qv ERROR &amp;&amp; echo $kernel_module &gt;&gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ipvs.conf || :</span><br><span class="line">done</span><br></pre></td></tr></table></div></figure>

<p><br />加载ipvs模块</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now systemd-modules-load.service</span><br></pre></td></tr></table></div></figure>

<p><br />查询ipvs是否加载</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ lsmod | grep ip_vs</span><br><span class="line">ip_vs_sh               12688  0 </span><br><span class="line">ip_vs_wrr              12697  0 </span><br><span class="line">ip_vs_rr               12600  11 </span><br><span class="line">ip_vs                 145497  17 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class="line">nf_conntrack          133095  7 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4</span><br><span class="line">libcrc32c              12644  3 ip_vs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></div></figure>


<p><a name="279b9293"></a></p>

        <h3 id="所有机器都设置k8s系统参数"   >
          <a href="#所有机器都设置k8s系统参数" class="heading-link"><i class="fas fa-link"></i></a>所有机器都设置k8s系统参数</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 &#x3D; 1           #禁用ipv6</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 &#x3D; 1       #禁用ipv6</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 &#x3D; 1            #禁用ipv6</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time &#x3D; 120   #决定检查过期多久邻居条目</span><br><span class="line">net.ipv4.conf.all.rp_filter &#x3D; 0              #关闭反向路由校验</span><br><span class="line">net.ipv4.conf.default.rp_filter &#x3D; 0          #关闭反向路由校验</span><br><span class="line">net.ipv4.conf.default.arp_announce &#x3D; 2       #始终使用与目标IP地址对应的最佳本地IP地址作为ARP请求的源IP地址</span><br><span class="line">net.ipv4.conf.lo.arp_announce &#x3D; 2            #始终使用与目标IP地址对应的最佳本地IP地址作为ARP请求的源IP地址</span><br><span class="line">net.ipv4.conf.all.arp_announce &#x3D; 2           #始终使用与目标IP地址对应的最佳本地IP地址作为ARP请求的源IP地址</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1                      #启用ip转发功能</span><br><span class="line">net.ipv4.tcp_max_tw_buckets &#x3D; 5000           #表示系统同时保持TIME_WAIT套接字的最大数量</span><br><span class="line">net.ipv4.tcp_syncookies &#x3D; 1                  #表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理</span><br><span class="line">net.ipv4.tcp_max_syn_backlog &#x3D; 1024          #接受SYN同包的最大客户端数量</span><br><span class="line">net.ipv4.tcp_synack_retries &#x3D; 2              #活动TCP连接重传次数</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1      #要求iptables对bridge的数据进行处理</span><br><span class="line">net.bridge.bridge-nf-call-iptables &#x3D; 1       #要求iptables对bridge的数据进行处理</span><br><span class="line">net.bridge.bridge-nf-call-arptables &#x3D; 1      #要求iptables对bridge的数据进行处理</span><br><span class="line">net.netfilter.nf_conntrack_max &#x3D; 2310720     #修改最大连接数</span><br><span class="line">fs.inotify.max_user_watches&#x3D;89100            #同一用户同时可以添加的watch数目</span><br><span class="line">fs.may_detach_mounts &#x3D; 1                     #允许文件卸载</span><br><span class="line">fs.file-max &#x3D; 52706963                       #系统级别的能够打开的文件句柄的数量</span><br><span class="line">fs.nr_open &#x3D; 52706963                        #单个进程可分配的最大文件数</span><br><span class="line">vm.overcommit_memory&#x3D;1                       #表示内核允许分配所有的物理内存，而不管当前的内存状态如何</span><br><span class="line">vm.panic_on_oom&#x3D;0                            #内核将检查是否有足够的可用内存供应用进程使用</span><br><span class="line">vm.swappiness &#x3D; 0                            #关注swap</span><br><span class="line">net.ipv4.tcp_keepalive_time &#x3D; 600            #修复ipvs模式下长连接timeout问题,小于900即可</span><br><span class="line">net.ipv4.tcp_keepalive_intvl &#x3D; 30            #探测没有确认时，重新发送探测的频度</span><br><span class="line">net.ipv4.tcp_keepalive_probes &#x3D; 10           #在认定连接失效之前，发送多少个TCP的keepalive探测包</span><br><span class="line">vm.max_map_count&#x3D;262144                      #定义了一个进程能拥有的最多的内存区域</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></div></figure>


<p><a name="c09a351c"></a></p>

        <h3 id="所有机器都设置文件最大数"   >
          <a href="#所有机器都设置文件最大数" class="heading-link"><i class="fas fa-link"></i></a>所有机器都设置文件最大数</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat&gt;&#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;kubernetes.conf&lt;&lt;EOF</span><br><span class="line">*       soft    nproc   131072</span><br><span class="line">*       hard    nproc   131072</span><br><span class="line">*       soft    nofile  131072</span><br><span class="line">*       hard    nofile  131072</span><br><span class="line">root    soft    nproc   131072</span><br><span class="line">root    hard    nproc   131072</span><br><span class="line">root    soft    nofile  131072</span><br><span class="line">root    hard    nofile  131072</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<p><a name="9082a5d6"></a></p>

        <h3 id="所有机器都设置docker-安装"   >
          <a href="#所有机器都设置docker-安装" class="heading-link"><i class="fas fa-link"></i></a>所有机器都设置docker 安装</h3>
      <p><a name="ceaf9f34"></a></p>

        <h4 id="docker-yum"   >
          <a href="#docker-yum" class="heading-link"><i class="fas fa-link"></i></a>docker yum</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;yum.repos.d&#x2F;  &amp;&amp;  wget https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br></pre></td></tr></table></div></figure>


<p><a name="78cbf33b"></a></p>

        <h4 id="官方脚本检查"   >
          <a href="#官方脚本检查" class="heading-link"><i class="fas fa-link"></i></a>官方脚本检查</h4>
      <p><br />docker官方的内核检查脚本建议<code>(RHEL7/CentOS7: User namespaces disabled; add &#39;user_namespace.enable=1&#39; to boot command line)</code><br /><br><br /><img src="https://raw.githubusercontent.com/tangwei0928/picture01/master/20200104211718.png#align=left&display=inline&height=121&margin=%5Bobject%20Object%5D&originHeight=121&originWidth=702&status=done&style=none&width=702"><br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grubby --args&#x3D;&quot;user_namespace.enable&#x3D;1&quot; --update-kernel&#x3D;&quot;$(grubby --default-kernel)&quot;</span><br><span class="line"></span><br><span class="line">#然后重启</span><br><span class="line">reboot</span><br></pre></td></tr></table></div></figure>


<p><a name="6232cdc9"></a></p>

        <h4 id="docker安装"   >
          <a href="#docker安装" class="heading-link"><i class="fas fa-link"></i></a>docker安装</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce -y</span><br></pre></td></tr></table></div></figure>


<p><a name="c99bd83b"></a></p>

        <h4 id="配置docker"   >
          <a href="#配置docker" class="heading-link"><i class="fas fa-link"></i></a>配置docker</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;completions&#x2F;docker &#x2F;etc&#x2F;bash_completion.d&#x2F;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;etc&#x2F;docker&#x2F;</span><br><span class="line"></span><br><span class="line">cat &gt; &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;],</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;live-restore&quot;: true,</span><br><span class="line">    &quot;max-concurrent-downloads&quot;: 10,</span><br><span class="line">    &quot;max-concurrent-uploads&quot;: 10,</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;2lefsjdg.mirror.aliyuncs.com&quot;],</span><br><span class="line">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">    &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check&#x3D;true&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<p><a name="f223c043"></a></p>

        <h4 id="启动docker"   >
          <a href="#启动docker" class="heading-link"><i class="fas fa-link"></i></a>启动docker</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now docker</span><br></pre></td></tr></table></div></figure>


<p><a name="75d97f7f"></a></p>

        <h2 id="kubeadm部署"   >
          <a href="#kubeadm部署" class="heading-link"><i class="fas fa-link"></i></a>kubeadm部署</h2>
      <p><a name="07df8c55"></a></p>

        <h3 id="所有机器都设置kubeadm-yum"   >
          <a href="#所有机器都设置kubeadm-yum" class="heading-link"><i class="fas fa-link"></i></a>所有机器都设置kubeadm yum</h3>
      <p><br />在所有节点操作<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name&#x3D;Kubernetes</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;repos&#x2F;kubernetes-el7-x86_64</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<p><a name="ce4ceb45"></a></p>

        <h3 id="maser节点安装"   >
          <a href="#maser节点安装" class="heading-link"><i class="fas fa-link"></i></a>maser节点安装</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install -y \</span><br><span class="line">    kubeadm-1.18.5 \</span><br><span class="line">    kubectl-1.18.5 \</span><br><span class="line">    kubelet-1.18.5 \</span><br><span class="line">    --disableexcludes&#x3D;kubernetes &amp;&amp; \</span><br><span class="line">    systemctl enable kubelet</span><br></pre></td></tr></table></div></figure>


<p><a name="2ac153da"></a></p>

        <h3 id="node节点安装"   >
          <a href="#node节点安装" class="heading-link"><i class="fas fa-link"></i></a>node节点安装</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y \</span><br><span class="line">    kubeadm-1.18.5 \</span><br><span class="line">    kubelet-1.18.5 \</span><br><span class="line">    --disableexcludes&#x3D;kubernetes &amp;&amp; \</span><br><span class="line">    systemctl enable kubelet</span><br></pre></td></tr></table></div></figure>


<p><a name="c91991ae"></a></p>

        <h3 id="master高可用"   >
          <a href="#master高可用" class="heading-link"><i class="fas fa-link"></i></a>master高可用</h3>
      <p><a name="pRKhb"></a></p>

        <h4 id="在所有节点部署一个nginx容器"   >
          <a href="#在所有节点部署一个nginx容器" class="heading-link"><i class="fas fa-link"></i></a>在所有节点部署一个nginx容器</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;kubernetes</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;etc&#x2F;kubernetes&#x2F;nginx.conf &lt;&lt; EOF</span><br><span class="line">user nginx nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  20240;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line">error_log &#x2F;var&#x2F;log&#x2F;nginx_error.log info;</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream kube-servers &#123;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server master01:6443 weight&#x3D;5 max_fails&#x3D;1 fail_timeout&#x3D;3s;</span><br><span class="line">        server master02:6443 weight&#x3D;5 max_fails&#x3D;1 fail_timeout&#x3D;3s;</span><br><span class="line">        server master03:6443 weight&#x3D;5 max_fails&#x3D;1 fail_timeout&#x3D;3s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8443 reuseport;</span><br><span class="line">        proxy_connect_timeout 3s;</span><br><span class="line">        proxy_timeout 3000s;</span><br><span class="line">        proxy_pass kube-servers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run --restart&#x3D;always \</span><br><span class="line">    -v &#x2F;etc&#x2F;kubernetes&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf \</span><br><span class="line">    -v &#x2F;etc&#x2F;localtime:&#x2F;etc&#x2F;localtime:ro \</span><br><span class="line">    --name k8sHA \</span><br><span class="line">    --net host \</span><br><span class="line">    -d \</span><br><span class="line">    nginx</span><br></pre></td></tr></table></div></figure>


<p><a name="d615260c"></a></p>

        <h3 id="kubeadm配置文件"   >
          <a href="#kubeadm配置文件" class="heading-link"><i class="fas fa-link"></i></a>kubeadm配置文件</h3>
      
        <h3 id="kubeadm100年证书-编译参考https-github-com-21ki-kubernetes-blob-master-github-workflows-go-yml"   >
          <a href="#kubeadm100年证书-编译参考https-github-com-21ki-kubernetes-blob-master-github-workflows-go-yml" class="heading-link"><i class="fas fa-link"></i></a>kubeadm100年证书 编译参考https://github.com/21ki/kubernetes/blob/master/.github/workflows/go.yml</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/21ki/kubernetes/releases/download/v1.19.1/kubeadm-v1.19.1.zip</span><br><span class="line">unzip kubeadm-v1.19.1.zip</span><br><span class="line">chmod +x kubeadm</span><br><span class="line">mv -f kubeadm /usr/bin/kubeadm</span><br></pre></td></tr></table></div></figure>

<p><br />在master01节点操作<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;root&#x2F;initconfig.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io&#x2F;v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">imageRepository: registry.aliyuncs.com&#x2F;k8sxio</span><br><span class="line">kubernetesVersion: v1.18.5</span><br><span class="line">certificatesDir: &#x2F;etc&#x2F;kubernetes&#x2F;pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">networking: </span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 169.0.0.0&#x2F;12</span><br><span class="line">  podSubnet: 10.0.0.0&#x2F;8  ##Cilium的pod段</span><br><span class="line">controlPlaneEndpoint: apiserver.k8s.local:8443</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: &quot;Node,RBAC&quot;</span><br><span class="line">    enable-admission-plugins: &quot;NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeClaimResize,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,Priority,PodPreset&quot;</span><br><span class="line">    runtime-config: api&#x2F;all&#x3D;true,settings.k8s.io&#x2F;v1alpha1&#x3D;true</span><br><span class="line">    storage-backend: etcd3</span><br><span class="line">    etcd-servers: https:&#x2F;&#x2F;192.168.33.101:2379,https:&#x2F;&#x2F;192.168.33.102:2379,https:&#x2F;&#x2F;192.168.33.103:2379 #修改对应的ip</span><br><span class="line">  certSANs:</span><br><span class="line">  - 10.96.0.1</span><br><span class="line">  - 127.0.0.1</span><br><span class="line">  - localhost</span><br><span class="line">  - apiserver.k8s.local</span><br><span class="line">  - 192.168.33.101 #修改对应的ip</span><br><span class="line">  - 192.168.33.102 #修改对应的ip</span><br><span class="line">  - 192.168.33.103 #修改对应的ip</span><br><span class="line">  - master01       #修改对应的hostname</span><br><span class="line">  - master02       #修改对应的hostname</span><br><span class="line">  - master03       #修改对应的hostname</span><br><span class="line">  - master</span><br><span class="line">  - kubernetes</span><br><span class="line">  - kubernetes.default </span><br><span class="line">  - kubernetes.default.svc </span><br><span class="line">  - kubernetes.default.svc.cluster.local</span><br><span class="line">  extraVolumes:</span><br><span class="line">  - hostPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    mountPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    name: localtime</span><br><span class="line">    readOnly: true</span><br><span class="line">controllerManager:</span><br><span class="line">  extraArgs:</span><br><span class="line">    bind-address: &quot;0.0.0.0&quot;</span><br><span class="line">    experimental-cluster-signing-duration: 867000h</span><br><span class="line">  extraVolumes:</span><br><span class="line">  - hostPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    mountPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    name: localtime</span><br><span class="line">    readOnly: true</span><br><span class="line">scheduler: </span><br><span class="line">  extraArgs:</span><br><span class="line">    bind-address: &quot;0.0.0.0&quot;</span><br><span class="line">  extraVolumes:</span><br><span class="line">  - hostPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    mountPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    name: localtime</span><br><span class="line">    readOnly: true</span><br><span class="line">dns:</span><br><span class="line">  type: CoreDNS</span><br><span class="line">  imageRepository: registry.aliyuncs.com&#x2F;k8sxio</span><br><span class="line">  imageTag: 1.7.0</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    imageRepository: registry.aliyuncs.com&#x2F;k8sxio</span><br><span class="line">    imageTag: 3.4.7</span><br><span class="line">    dataDir: &#x2F;var&#x2F;lib&#x2F;etcd</span><br><span class="line">    serverCertSANs:</span><br><span class="line">    - master</span><br><span class="line">    - 192.168.33.101   #修改对应的ip</span><br><span class="line">    - 192.168.33.102   #修改对应的ip</span><br><span class="line">    - 192.168.33.103   #修改对应的ip</span><br><span class="line">    - master01      #修改对应的hostname</span><br><span class="line">    - master02      #修改对应的hostname</span><br><span class="line">    - master03      #修改对应的hostname</span><br><span class="line">    peerCertSANs:</span><br><span class="line">    - master</span><br><span class="line">    - 192.168.33.101     #修改对应的ip</span><br><span class="line">    - 192.168.33.102     #修改对应的ip</span><br><span class="line">    - 192.168.33.103     #修改对应的ip</span><br><span class="line">    - master01           #修改对应的hostname</span><br><span class="line">    - master02           #修改对应的hostname</span><br><span class="line">    - master03           #修改对应的hostname</span><br><span class="line">    extraArgs:</span><br><span class="line">      auto-compaction-retention: &quot;1h&quot;</span><br><span class="line">      max-request-bytes: &quot;33554432&quot;</span><br><span class="line">      quota-backend-bytes: &quot;8589934592&quot;</span><br><span class="line">      enable-v2: &quot;false&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io&#x2F;v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs</span><br><span class="line">ipvs:</span><br><span class="line">  excludeCIDRs: null</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">  strictARP: false</span><br><span class="line">  syncPeriod: 15s</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">---</span><br><span class="line">apiVersion: kubelet.config.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">cgroupDriver: &quot;systemd&quot;</span><br><span class="line">failSwapOn: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p><br />检查文件是否错误，忽略<code>warning</code>，错误的话会抛出error，没错则会输出到包含字符串<code>kubeadm join xxx</code>啥的<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config &#x2F;root&#x2F;initconfig.yaml --dry-run</span><br></pre></td></tr></table></div></figure>

<p><br />预先拉取镜像<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull --config &#x2F;root&#x2F;initconfig.yaml</span><br></pre></td></tr></table></div></figure>


<p><a name="292262c8"></a></p>

        <h3 id="部署master"   >
          <a href="#部署master" class="heading-link"><i class="fas fa-link"></i></a>部署master</h3>
      <p><br />在master01节点操作<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config &#x2F;root&#x2F;initconfig.yaml --upload-certs</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">You can now join any number of the control-plane node running the following command on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join apiserver.k8s.local:8443 --token 8lmdqu.cqe8r0rxa0056vmm \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:5ca87fff6b414a0872ab5452972d7e36e4bad7ab3a0bc385abe0138ce671eabb \</span><br><span class="line">    --control-plane --certificate-key 7a1d432b2834464a82fd7cba0e9e5d8409c492cf9a4ee6328fb4f84b6a78934a</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use </span><br><span class="line">&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join apiserver.k8s.local:8443 --token 8lmdqu.cqe8r0rxa0056vmm \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:5ca87fff6b414a0872ab5452972d7e36e4bad7ab3a0bc385abe0138ce671eabb</span><br></pre></td></tr></table></div></figure>

<p><br />复制kubectl的kubeconfig，kubectl的kubeconfig路径默认是<code>~/.kube/config</code><br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME&#x2F;.kube</span><br><span class="line"></span><br><span class="line">sudo cp &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></div></figure>

<p><br />init的yaml信息实际上会存在集群的configmap里，我们可以随时查看，该yaml在其他node和master join的时候会使用到<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get cm kubeadm-config -o yaml</span><br></pre></td></tr></table></div></figure>


<p><a name="bcaa46b0"></a></p>

        <h4 id="设置ep的rbac"   >
          <a href="#设置ep的rbac" class="heading-link"><i class="fas fa-link"></i></a>设置ep的rbac</h4>
      <p><br />kube-apiserver的web健康检查路由有权限，我们需要开放用来监控或者对接SLB的健康检查<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;root&#x2F;healthz-rbac.yml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: healthz-reader</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: healthz-reader</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:authenticated</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:unauthenticated</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: healthz-reader</span><br><span class="line">rules:</span><br><span class="line">- nonResourceURLs: [&quot;&#x2F;healthz&quot;, &quot;&#x2F;healthz&#x2F;*&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;post&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &#x2F;root&#x2F;healthz-rbac.yml</span><br></pre></td></tr></table></div></figure>


<p><a name="c1edf8ea"></a></p>

        <h4 id="配置其他master的k8s管理组件"   >
          <a href="#配置其他master的k8s管理组件" class="heading-link"><i class="fas fa-link"></i></a>配置其他master的k8s管理组件</h4>
      <p>将master01上的配置文件发到其他2个master节点上</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for node in 192.168.33.102 192.168.33.103;do</span><br><span class="line">    ssh $node &#39;mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#39;</span><br><span class="line">    scp -r &#x2F;root&#x2F;initconfig.yaml $node:&#x2F;root&#x2F;initconfig.yaml</span><br><span class="line">    scp -r &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.* $node:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">    scp -r &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.* $node:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">    scp -r &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.* $node:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">    scp -r &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.* $node:&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;</span><br><span class="line">done</span><br></pre></td></tr></table></div></figure>


<p><a name="7d082cef"></a></p>

        <h4 id="其他master-join进来"   >
          <a href="#其他master-join进来" class="heading-link"><i class="fas fa-link"></i></a>其他master join进来</h4>
      <p>先拉取镜像</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull --config &#x2F;root&#x2F;initconfig.yaml</span><br></pre></td></tr></table></div></figure>
<p>查看master01上 带有<code>--control-plane</code>的那一行</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join apiserver.k8s.local:8443 --token 8lmdqu.cqe8r0rxa0056vmm \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:5ca87fff6b414a0872ab5452972d7e36e4bad7ab3a0bc385abe0138ce671eabb \</span><br><span class="line">    --control-plane --certificate-key 7a1d432b2834464a82fd7cba0e9e5d8409c492cf9a4ee6328fb4f84b6a78934a</span><br></pre></td></tr></table></div></figure>


<p><a name="6af224e5"></a></p>

        <h4 id="所有master配置kubectl"   >
          <a href="#所有master配置kubectl" class="heading-link"><i class="fas fa-link"></i></a>所有master配置kubectl</h4>
      <p><a name="0bc22c29"></a></p>

        <h5 id="准备kubectl的kubeconfig"   >
          <a href="#准备kubectl的kubeconfig" class="heading-link"><i class="fas fa-link"></i></a>准备kubectl的kubeconfig</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME&#x2F;.kube</span><br><span class="line"></span><br><span class="line">sudo cp &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></div></figure>


<p><a name="21aba698"></a></p>

        <h5 id="设置kubectl的补全脚本"   >
          <a href="#设置kubectl的补全脚本" class="heading-link"><i class="fas fa-link"></i></a>设置kubectl的补全脚本</h5>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bash-comp*</span><br><span class="line"></span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line"></span><br><span class="line">echo &#39;source &lt;(kubectl completion bash)&#39; &gt;&gt; ~&#x2F;.bashrc</span><br></pre></td></tr></table></div></figure>


<p><a name="50981283"></a></p>

        <h4 id="master配置etcdctl"   >
          <a href="#master配置etcdctl" class="heading-link"><i class="fas fa-link"></i></a>master配置etcdctl</h4>
      <p><br />所有master节点先复制出容器里的etcdctl<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp &#96;docker ps -a | awk &#39;&#x2F;k8s_etcd&#x2F;&#123;print $1&#125;&#39;|head -n1&#96;:&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcdctl &#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcdctl</span><br></pre></td></tr></table></div></figure>

<p><br />编写一个简单别名，记得替换对应的ip</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;profile.d&#x2F;etcd.sh&lt;&lt;&#39;EOF&#39;</span><br><span class="line">ETCD_CERET_DIR&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;</span><br><span class="line">ETCD_CA_FILE&#x3D;ca.crt</span><br><span class="line">ETCD_KEY_FILE&#x3D;healthcheck-client.key</span><br><span class="line">ETCD_CERT_FILE&#x3D;healthcheck-client.crt</span><br><span class="line">ETCD_EP&#x3D;https:&#x2F;&#x2F;192.168.33.101:2379,https:&#x2F;&#x2F;192.168.33.102:2379,https:&#x2F;&#x2F;192.168.33.103:2379</span><br><span class="line"></span><br><span class="line">alias etcd_v3&#x3D;&quot;ETCDCTL_API&#x3D;3 \</span><br><span class="line">    etcdctl   \</span><br><span class="line">   --cert $&#123;ETCD_CERET_DIR&#125;&#x2F;$&#123;ETCD_CERT_FILE&#125; \</span><br><span class="line">   --key $&#123;ETCD_CERET_DIR&#125;&#x2F;$&#123;ETCD_KEY_FILE&#125; \</span><br><span class="line">   --cacert $&#123;ETCD_CERET_DIR&#125;&#x2F;$&#123;ETCD_CA_FILE&#125; \</span><br><span class="line">   --endpoints $ETCD_EP&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source  &#x2F;etc&#x2F;profile.d&#x2F;etcd.sh</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">etcd_v3 endpoint status --write-out&#x3D;table</span><br><span class="line"></span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">|          ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br><span class="line">| https:&#x2F;&#x2F;192.168.33.101:2379 | c724c500884441af |  3.4.7 |  1.6 MB |      true |         7 |       1865 |</span><br><span class="line">| https:&#x2F;&#x2F;192.168.33.102:2379 | 3dcceec24ad5c5d4 |  3.4.7 |  1.6 MB |     false |         7 |       1865 |</span><br><span class="line">| https:&#x2F;&#x2F;192.168.33.103:2379 | bc21062efb4a5d4c |  3.4.7 |  1.5 MB |     false |         7 |       1865 |</span><br><span class="line">+-----------------------------+------------------+---------+---------+-----------+-----------+------------+</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">etcd_v3 endpoint health --write-out&#x3D;table</span><br><span class="line">+-----------------------------+--------+-------------+-------+</span><br><span class="line">|          ENDPOINT           | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+-----------------------------+--------+-------------+-------+</span><br><span class="line">| https:&#x2F;&#x2F;192.168.33.103:2379 |   true | 19.288026ms |       |</span><br><span class="line">| https:&#x2F;&#x2F;192.168.33.102:2379 |   true |   19.2603ms |       |</span><br><span class="line">| https:&#x2F;&#x2F;192.168.33.101:2379 |   true | 22.490443ms |       |</span><br><span class="line">+-----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></div></figure>

<p><br />配置etcd备份脚本<br />记得替换对应的ip</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;opt&#x2F;etcd</span><br><span class="line"></span><br><span class="line">cat&gt;&#x2F;opt&#x2F;etcd&#x2F;etcd_cron.sh&lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -e</span><br><span class="line">source  &#x2F;etc&#x2F;profile</span><br><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin</span><br><span class="line">master&#x3D;&#96;ETCDCTL_API&#x3D;3 etcdctl --endpoints&#x3D;&quot;https:&#x2F;&#x2F;192.168.33.101:2379,https:&#x2F;&#x2F;192.168.33.102:2379,https:&#x2F;&#x2F;192.168.33.103:2379&quot; --cert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.crt --key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.key --cacert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt  endpoint status  | grep true|awk -F&quot;,&quot; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line">:  $&#123;bak_dir:&#x3D;&#x2F;root&#x2F;&#125; #缺省备份目录,可以修改成存在的目录</span><br><span class="line">:  $&#123;cert_dir:&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;&#125;</span><br><span class="line">:  $&#123;endpoints:&#x3D;$master&#125;</span><br><span class="line">bak_prefix&#x3D;&#39;etcd-&#39;</span><br><span class="line">cmd_suffix&#x3D;&#39;date +%Y-%m-%d-%H-%M&#39;</span><br><span class="line">bak_suffix&#x3D;&#39;.db&#39;</span><br><span class="line"></span><br><span class="line">#将规范化后的命令行参数分配至位置参数（$1,$2,...)</span><br><span class="line">temp&#x3D;&#96;getopt -n $0 -o c:d: -u -- &quot;$@&quot;&#96;</span><br><span class="line"></span><br><span class="line">[ $? !&#x3D; 0 ] &amp;&amp; &#123;</span><br><span class="line">    echo &#39;</span><br><span class="line">Examples:</span><br><span class="line">  # just save once</span><br><span class="line">  bash $0 &#x2F;tmp&#x2F;etcd.db</span><br><span class="line">  # save in contab and  keep 5</span><br><span class="line">  bash $0 -c 5</span><br><span class="line">    &#39;</span><br><span class="line">    exit 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">set -- $temp</span><br><span class="line"># -c 备份保留副本数量</span><br><span class="line"># -d 指定备份存放目录</span><br><span class="line"></span><br><span class="line">while true;do</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">        -c)</span><br><span class="line">            [ -z &quot;$bak_count&quot; ] &amp;&amp; bak_count&#x3D;$2</span><br><span class="line">            printf -v null %d &quot;$bak_count&quot; &amp;&gt;&#x2F;dev&#x2F;null || \</span><br><span class="line">                &#123; echo &#39;the value of the -c must be number&#39;;exit 1; &#125;</span><br><span class="line">            shift 2</span><br><span class="line">            ;;</span><br><span class="line">        -d)</span><br><span class="line">            [ ! -d &quot;$2&quot; ] &amp;&amp; mkdir -p $2</span><br><span class="line">            bak_dir&#x3D;$2</span><br><span class="line">            shift 2</span><br><span class="line">            ;;</span><br><span class="line">         *)</span><br><span class="line">            [[ -z &quot;$1&quot; || &quot;$1&quot; &#x3D;&#x3D; &#39;--&#39; ]] &amp;&amp; &#123; shift;break; &#125;</span><br><span class="line">            echo &quot;Internal error!&quot;</span><br><span class="line">            exit 1</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd::cron::save()&#123;</span><br><span class="line">    cd $bak_dir&#x2F;</span><br><span class="line">    ETCDCTL_API&#x3D;3 etcdctl --endpoints&#x3D;$endpoints --cert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.crt --key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;server.key --cacert&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt  snapshot save  $bak_prefix$($cmd_suffix)$bak_suffix</span><br><span class="line">    rm_files&#x3D;&#96;ls -t $bak_prefix*$bak_suffix | tail -n +$[bak_count+1]&#96;</span><br><span class="line">    if [ -n &quot;$rm_files&quot; ];then</span><br><span class="line">        rm -f $rm_files</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()&#123;</span><br><span class="line">    [ -n &quot;$bak_count&quot; ] &amp;&amp; etcd::cron::save || etcd_v3 snapshot save $@</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main $@</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>

<p><br />crontab -e添加下面内容自动保留四个备份副本<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * * bash &#x2F;opt&#x2F;etcd&#x2F;etcd_cron.sh  -c 4 -d &#x2F;opt&#x2F;etcd&#x2F; &amp;&gt;&#x2F;dev&#x2F;null</span><br></pre></td></tr></table></div></figure>


<p><a name="ab1dac9e"></a></p>

        <h3 id="部署node"   >
          <a href="#部署node" class="heading-link"><i class="fas fa-link"></i></a>部署node</h3>
      <p><br />在node节点执行<br /><br><br />和master的join一样，提前准备好环境和docker，然后join的时候不需要带<code>--control-plane</code><br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join apiserver.k8s.local:8443 --token 8lmdqu.cqe8r0rxa0056vmm \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:5ca87fff6b414a0872ab5452972d7e36e4bad7ab3a0bc385abe0138ce671eabb</span><br></pre></td></tr></table></div></figure>


<p><a name="fedbcac8"></a></p>

        <h3 id="打标签"   >
          <a href="#打标签" class="heading-link"><i class="fas fa-link"></i></a>打标签</h3>
      <p><br />role只是一个label，可以打label，想显示啥就<code>node-role.kubernetes.io/xxxx</code><br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get nodes</span><br><span class="line">NAME       STATUS     ROLES    AGE   VERSION</span><br><span class="line">master01   NotReady   master   17m   v1.18.5</span><br><span class="line">master02   NotReady   master   14m   v1.18.5</span><br><span class="line">master03   NotReady   master   13m   v1.18.5</span><br><span class="line">node01     NotReady   &lt;none&gt;   24s   v1.18.5</span><br><span class="line">node02     NotReady   &lt;none&gt;   18s   v1.18.5</span><br><span class="line">node03     NotReady   &lt;none&gt;   11s   v1.18.5</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl label node node01 node-role.kubernetes.io&#x2F;node&#x3D;&quot;&quot;</span><br><span class="line">node&#x2F;node01 labeled</span><br><span class="line">[root@master01 ~]# kubectl label node node02 node-role.kubernetes.io&#x2F;node&#x3D;&quot;&quot;</span><br><span class="line">node&#x2F;node02 labeled</span><br><span class="line">[root@master01 ~]# kubectl label node node03 node-role.kubernetes.io&#x2F;node&#x3D;&quot;&quot;</span><br><span class="line">node&#x2F;node03 labeled</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl get nodes </span><br><span class="line">NAME       STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01   NotReady   master   25m     v1.18.5</span><br><span class="line">master02   NotReady   master   22m     v1.18.5</span><br><span class="line">master03   NotReady   master   21m     v1.18.5</span><br><span class="line">node01     NotReady   node     8m      v1.18.5</span><br><span class="line">node02     NotReady   node     7m54s   v1.18.5</span><br><span class="line">node03     NotReady   node     7m47s   v1.18.5</span><br></pre></td></tr></table></div></figure>


<p><a name="5550f7bc"></a></p>

        <h2 id="部署网络插件Cilium"   >
          <a href="#部署网络插件Cilium" class="heading-link"><i class="fas fa-link"></i></a>部署网络插件Cilium</h2>
      <p><a name="czUsA"></a></p>

        <h3 id="准备helm3"   >
          <a href="#准备helm3" class="heading-link"><i class="fas fa-link"></i></a>准备helm3</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;helm&#x2F;helm&#x2F;releases</span><br></pre></td></tr></table></div></figure>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2020/png/1176682/1594439663818-f2da1f2a-1169-4451-af76-6adb1fe9e64a.png#align=left&display=inline&height=856&margin=%5Bobject%20Object%5D&name=image.png&originHeight=856&originWidth=1449&size=117906&status=done&style=none&width=1449)<br /> -->链接: [https://pan.baidu.com/s/13qsdwCzaKfnZNlDarsBYpg](https://pan.baidu.com/s/13qsdwCzaKfnZNlDarsBYpg) 提取码: wu22
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf helm-v3.3.0-rc.1-linux-amd64.tar</span><br></pre></td></tr></table></div></figure>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2020/png/1176682/1594439897751-baf387d5-6591-474f-b0b2-202450246420.png#align=left&display=inline&height=293&margin=%5Bobject%20Object%5D&name=image.png&originHeight=293&originWidth=843&size=21820&status=done&style=none&width=843) -->
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x linux-amd64&#x2F;helm </span><br><span class="line">mv linux-amd64&#x2F;helm  &#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></div></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594439952860-de4aecf8-5f2b-4062-b6b4-750bf81bdccc.png#align=left&display=inline&height=106&margin=%5Bobject%20Object%5D&name=image.png&originHeight=106&originWidth=491&size=7265&status=done&style=none&width=491" alt="image.png"><br><a name="UuH7B"></a></p>

        <h3 id="部署Cilium"   >
          <a href="#部署Cilium" class="heading-link"><i class="fas fa-link"></i></a>部署Cilium</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;cilium&#x2F;cilium</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add cilium https:&#x2F;&#x2F;helm.cilium.io</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">helm install cilium cilium&#x2F;cilium --version 1.8.1 \</span><br><span class="line">   --namespace kube-system \</span><br><span class="line">   --set global.nodeinit.enabled&#x3D;true \</span><br><span class="line">   --set global.externalIPs.enabled&#x3D;true \</span><br><span class="line">   --set global.nodePort.enabled&#x3D;true \</span><br><span class="line">   --set global.hostPort.enabled&#x3D;true \</span><br><span class="line">   --set global.pullPolicy&#x3D;IfNotPresent \</span><br><span class="line">   --set config.ipam&#x3D;cluster-pool \</span><br><span class="line">   --set global.hubble.enabled&#x3D;true \</span><br><span class="line">   --set global.hubble.listenAddress&#x3D;&quot;:4244&quot; \</span><br><span class="line">   --set global.hubble.relay.enabled&#x3D;true \</span><br><span class="line">   --set global.hubble.metrics.enabled&#x3D;&quot;&#123;dns,drop,tcp,flow,port-distribution,icmp,http&#125;&quot; \</span><br><span class="line">   --set global.prometheus.enabled&#x3D;true \</span><br><span class="line">   --set global.operatorPrometheus.enabled&#x3D;true \</span><br><span class="line">   --set global.hubble.ui.enabled&#x3D;true</span><br></pre></td></tr></table></div></figure>

<p><br />hubble-ui镜像下载<br />链接: <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://pan.baidu.com/s/1gRVM37RjFyEebBfQ-1MyJQ" >https://pan.baidu.com/s/1gRVM37RjFyEebBfQ-1MyJQ</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 提取码: gtyv<br><a name="db06c78d"></a></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a name="XYeYx"></a></p>

        <h2 id="测试"   >
          <a href="#测试" class="heading-link"><i class="fas fa-link"></i></a>测试</h2>
      <p><a name="cbdc82b1"></a></p>

        <h3 id="验证集群可用性"   >
          <a href="#验证集群可用性" class="heading-link"><i class="fas fa-link"></i></a>验证集群可用性</h3>
      <p><br />最基本的3master3node集群搭建完成了<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get pods --all-namespaces -w</span><br><span class="line">NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   cilium-4qs42                       1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-5v9xc                       1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-gw5nh                       1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-node-init-4cvlf             1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-node-init-4jxhb             1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-node-init-5m5ns             1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-node-init-klw8c             1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-node-init-kvgwp             1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-node-init-sc2wb             1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-nz8wc                       1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-operator-657978fb5b-j8bzv   1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-p6mzq                       1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   cilium-xchz5                       1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   coredns-84b99c4749-bb54k           1&#x2F;1     Running   0          29m</span><br><span class="line">kube-system   coredns-84b99c4749-q9z4r           1&#x2F;1     Running   0          29m</span><br><span class="line">kube-system   etcd-master01                      1&#x2F;1     Running   0          29m</span><br><span class="line">kube-system   etcd-master02                      1&#x2F;1     Running   0          26m</span><br><span class="line">kube-system   etcd-master03                      1&#x2F;1     Running   0          26m</span><br><span class="line">kube-system   hubble-relay-55c5cbdfcb-m4bx6      1&#x2F;1     Running   0          11m</span><br><span class="line">kube-system   hubble-ui-66fdcdc6d-czz8k          1&#x2F;1     Running   0          14m</span><br><span class="line">kube-system   kube-apiserver-master01            1&#x2F;1     Running   0          29m</span><br><span class="line">kube-system   kube-apiserver-master02            1&#x2F;1     Running   0          27m</span><br><span class="line">kube-system   kube-apiserver-master03            1&#x2F;1     Running   0          25m</span><br><span class="line">kube-system   kube-controller-manager-master01   1&#x2F;1     Running   1          29m</span><br><span class="line">kube-system   kube-controller-manager-master02   1&#x2F;1     Running   0          27m</span><br><span class="line">kube-system   kube-controller-manager-master03   1&#x2F;1     Running   0          25m</span><br><span class="line">kube-system   kube-proxy-9k98m                   1&#x2F;1     Running   0          26m</span><br><span class="line">kube-system   kube-proxy-ddhd4                   1&#x2F;1     Running   0          25m</span><br><span class="line">kube-system   kube-proxy-dqd45                   1&#x2F;1     Running   0          25m</span><br><span class="line">kube-system   kube-proxy-jbwtg                   1&#x2F;1     Running   0          27m</span><br><span class="line">kube-system   kube-proxy-mj75f                   1&#x2F;1     Running   0          29m</span><br><span class="line">kube-system   kube-proxy-xjpkd                   1&#x2F;1     Running   0          25m</span><br><span class="line">kube-system   kube-scheduler-master01            1&#x2F;1     Running   1          29m</span><br><span class="line">kube-system   kube-scheduler-master02            1&#x2F;1     Running   0          27m</span><br><span class="line">kube-system   kube-scheduler-master03            1&#x2F;1     Running   0          25m</span><br></pre></td></tr></table></div></figure>


<p><a name="j67Rf"></a></p>

        <h3 id="重启docker，kubelet"   >
          <a href="#重启docker，kubelet" class="heading-link"><i class="fas fa-link"></i></a>重启docker，kubelet</h3>
      <p>由于kubeadm默认使用cgoupfs，官方推荐用systemd，所有节点都得进行检查和修改成systemd，然后重启docker，kubelelt<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1593015648865-aa8e2229-aa2e-41ff-bf50-7d9dbad7d1ae.png#align=left&display=inline&height=334&margin=%5Bobject%20Object%5D&name=image.png&originHeight=334&originWidth=1075&size=30776&status=done&style=none&width=1075" alt="image.png"></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;kubeadm-flags.env</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br></pre></td></tr></table></div></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1593015747647-1c5d6eee-a8cb-47b1-8aed-eb97ad54dd19.png#align=left&display=inline&height=320&margin=%5Bobject%20Object%5D&name=image.png&originHeight=320&originWidth=972&size=29352&status=done&style=none&width=972" alt="image.png"><br /><br><br />所有节点先重启docker 再重启kubelet</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get  nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION</span><br><span class="line">master01   Ready    master   37m   v1.18.5</span><br><span class="line">master02   Ready    master   34m   v1.18.5</span><br><span class="line">master03   Ready    master   33m   v1.18.5</span><br><span class="line">node01     Ready    node     19m   v1.18.5</span><br><span class="line">node02     Ready    node     19m   v1.18.5</span><br><span class="line">node03     Ready    node     19m   v1.18.5</span><br></pre></td></tr></table></div></figure>


<p><a name="demo"></a></p>

        <h3 id="demo测试"   >
          <a href="#demo测试" class="heading-link"><i class="fas fa-link"></i></a>demo测试</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:alpine</span><br><span class="line">        name: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:1.28.4</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br></pre></td></tr></table></div></figure>


<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl get all  -o wide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod&#x2F;busybox                  1&#x2F;1     Running   0          73s   10.244.186.194   node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod&#x2F;nginx-5c559d5697-24zck   1&#x2F;1     Running   0          73s   10.244.186.193   node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">service&#x2F;kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443&#x2F;TCP   42m   &lt;none&gt;</span><br><span class="line">service&#x2F;nginx        ClusterIP   10.111.219.3   &lt;none&gt;        80&#x2F;TCP    73s   app&#x3D;nginx</span><br><span class="line"></span><br><span class="line">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">deployment.apps&#x2F;nginx   1&#x2F;1     1            1           73s   nginx        nginx:alpine   app&#x3D;nginx</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">replicaset.apps&#x2F;nginx-5c559d5697   1         1         1       73s   nginx        nginx:alpine   app&#x3D;nginx,pod-template-hash&#x3D;5c559d5697</span><br></pre></td></tr></table></div></figure>


<p><a name="439107f4"></a></p>

        <h4 id="验证集群dns"   >
          <a href="#验证集群dns" class="heading-link"><i class="fas fa-link"></i></a>验证集群dns</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl exec -ti busybox -- nslookup kubernetes</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:	kubernetes.default.svc.cluster.local</span><br><span class="line">Address: 10.96.0.1</span><br></pre></td></tr></table></div></figure>


<p><a name="72f60fe4"></a></p>

        <h4 id="测试nginx是否通"   >
          <a href="#测试nginx是否通" class="heading-link"><i class="fas fa-link"></i></a>测试nginx是否通</h4>
      <p><br />在master上curl nginx的pod的ip出现nginx的index内容即集群正常<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# curl 10.244.186.193</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;&#x2F;title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.org&#x2F;&quot;&gt;nginx.org&lt;&#x2F;a&gt;.&lt;br&#x2F;&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.com&#x2F;&quot;&gt;nginx.com&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></div></figure>

<p><br />在master上curl nginx的svc的ip出现nginx的index内容即集群正常<br /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# curl 10.111.219.3</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;&#x2F;title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.org&#x2F;&quot;&gt;nginx.org&lt;&#x2F;a&gt;.&lt;br&#x2F;&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.com&#x2F;&quot;&gt;nginx.com&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></div></figure>

<br />
<br />

<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# kubectl exec -ti busybox -- nslookup nginx</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:	nginx.default.svc.cluster.local</span><br><span class="line">Address: 10.111.219.3</span><br></pre></td></tr></table></div></figure>


<p><a name="009fab47"></a></p>

        <h4 id="ipvs验证"   >
          <a href="#ipvs验证" class="heading-link"><i class="fas fa-link"></i></a>ipvs验证</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.33.101:6443          Masq    1      1          0         </span><br><span class="line">  -&gt; 192.168.33.102:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.33.103:6443          Masq    1      1          0         </span><br><span class="line">TCP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.140.65:53             Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.140.67:53             Masq    1      0          0         </span><br><span class="line">TCP  10.96.0.10:9153 rr</span><br><span class="line">  -&gt; 10.244.140.65:9153           Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.140.67:9153           Masq    1      0          0         </span><br><span class="line">TCP  10.111.219.3:80 rr</span><br><span class="line">  -&gt; 10.244.186.193:80            Masq    1      0          0         </span><br><span class="line">UDP  10.96.0.10:53 rr</span><br><span class="line">  -&gt; 10.244.140.65:53             Masq    1      0          0         </span><br><span class="line">  -&gt; 10.244.140.67:53             Masq    1      0          0</span><br></pre></td></tr></table></div></figure>


<p><a name="SMT45"></a></p>

        <h3 id="网络可视化神器-Hubble"   >
          <a href="#网络可视化神器-Hubble" class="heading-link"><i class="fas fa-link"></i></a>网络可视化神器 Hubble</h3>
      <p> <code>Cilium</code> 强大之处就是提供了简单高效的网络可视化功能，它是通过 <strong>Hubble</strong> 组件完成的。<strong>Cilium 在 1.7 版本后推出并开源了 Hubble</strong>，它是专门为网络可视化设计，能够利用 <code>Cilium</code> 提供的 <code>eBPF</code> 数据路径，获得对 Kubernetes 应用和服务的网络流量的深度可见性。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc -n kube-system  hubble-ui</span><br></pre></td></tr></table></div></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594448142087-820ba694-af0a-46cf-af10-f07ad6cdf568.png#align=left&display=inline&height=305&margin=%5Bobject%20Object%5D&name=image.png&originHeight=305&originWidth=461&size=14334&status=done&style=none&width=461" alt="image.png"><br /><br><br /><img src="https://cdn.nlark.com/yuque/0/2020/png/1176682/1594451204489-5078f6fb-54fe-4afc-a63b-acd44961ee88.png#align=left&display=inline&height=1040&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1040&originWidth=1920&size=276479&status=done&style=none&width=1920" alt="image.png"><br>[转载]<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/xiaowei-trt7k/tw/ah0ls0" >https://www.yuque.com/xiaowei-trt7k/tw/ah0ls0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="http://zhho.cn">Hao Zhang</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="http://zhho.cn/2020/09/24/k8s-network-cilium/">http://zhho.cn/2020/09/24/k8s-network-cilium/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/09/27/Centos7%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%82%E5%90%88k8s%E8%BF%90%E8%A1%8C%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Centos7初始化适合k8s运行的系统环境</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2020/09/24/tomcat%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"><span class="paginator-prev__text">tomcat安装部署</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%AF%B4%E7%9A%84kubeadm"><span class="toc-number">1.</span> <span class="toc-text">
          不得不说的kubeadm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">
          架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#master%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">
          master的组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">
          node的组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">3.</span> <span class="toc-text">
          环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E7%BB%9F%E4%B8%80hosts"><span class="toc-number">3.1.</span> <span class="toc-text">
          所有主机统一hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">
          所有机器升级内核（可选）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E9%A1%B9"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          设置启动项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E9%83%BD%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%8Cswap%EF%BC%8Cselinux"><span class="toc-number">3.3.</span> <span class="toc-text">
          所有机器都关闭防火墙，swap，selinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8yum%E5%87%86%E5%A4%87"><span class="toc-number">3.4.</span> <span class="toc-text">
          所有机器yum准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E9%83%BD%E5%8A%A0%E8%BD%BDipvs"><span class="toc-number">3.5.</span> <span class="toc-text">
          所有机器都加载ipvs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E9%83%BD%E8%AE%BE%E7%BD%AEk8s%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0"><span class="toc-number">3.6.</span> <span class="toc-text">
          所有机器都设置k8s系统参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E9%83%BD%E8%AE%BE%E7%BD%AE%E6%96%87%E4%BB%B6%E6%9C%80%E5%A4%A7%E6%95%B0"><span class="toc-number">3.7.</span> <span class="toc-text">
          所有机器都设置文件最大数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E9%83%BD%E8%AE%BE%E7%BD%AEdocker-%E5%AE%89%E8%A3%85"><span class="toc-number">3.8.</span> <span class="toc-text">
          所有机器都设置docker 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-yum"><span class="toc-number">3.8.1.</span> <span class="toc-text">
          docker yum</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E8%84%9A%E6%9C%AC%E6%A3%80%E6%9F%A5"><span class="toc-number">3.8.2.</span> <span class="toc-text">
          官方脚本检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.8.3.</span> <span class="toc-text">
          docker安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEdocker"><span class="toc-number">3.8.4.</span> <span class="toc-text">
          配置docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8docker"><span class="toc-number">3.8.5.</span> <span class="toc-text">
          启动docker</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm%E9%83%A8%E7%BD%B2"><span class="toc-number">4.</span> <span class="toc-text">
          kubeadm部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E6%9C%BA%E5%99%A8%E9%83%BD%E8%AE%BE%E7%BD%AEkubeadm-yum"><span class="toc-number">4.1.</span> <span class="toc-text">
          所有机器都设置kubeadm yum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maser%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="toc-number">4.2.</span> <span class="toc-text">
          maser节点安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.</span> <span class="toc-text">
          node节点安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#master%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.4.</span> <span class="toc-text">
          master高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAnginx%E5%AE%B9%E5%99%A8"><span class="toc-number">4.4.1.</span> <span class="toc-text">
          在所有节点部署一个nginx容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubeadm%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.</span> <span class="toc-text">
          kubeadm配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubeadm100%E5%B9%B4%E8%AF%81%E4%B9%A6-%E7%BC%96%E8%AF%91%E5%8F%82%E8%80%83https-github-com-21ki-kubernetes-blob-master-github-workflows-go-yml"><span class="toc-number">4.6.</span> <span class="toc-text">
          kubeadm100年证书 编译参考https:&#x2F;&#x2F;github.com&#x2F;21ki&#x2F;kubernetes&#x2F;blob&#x2F;master&#x2F;.github&#x2F;workflows&#x2F;go.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2master"><span class="toc-number">4.7.</span> <span class="toc-text">
          部署master</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEep%E7%9A%84rbac"><span class="toc-number">4.7.1.</span> <span class="toc-text">
          设置ep的rbac</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%B6%E4%BB%96master%E7%9A%84k8s%E7%AE%A1%E7%90%86%E7%BB%84%E4%BB%B6"><span class="toc-number">4.7.2.</span> <span class="toc-text">
          配置其他master的k8s管理组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96master-join%E8%BF%9B%E6%9D%A5"><span class="toc-number">4.7.3.</span> <span class="toc-text">
          其他master join进来</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E6%9C%89master%E9%85%8D%E7%BD%AEkubectl"><span class="toc-number">4.7.4.</span> <span class="toc-text">
          所有master配置kubectl</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87kubectl%E7%9A%84kubeconfig"><span class="toc-number">4.7.4.1.</span> <span class="toc-text">
          准备kubectl的kubeconfig</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEkubectl%E7%9A%84%E8%A1%A5%E5%85%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">4.7.4.2.</span> <span class="toc-text">
          设置kubectl的补全脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#master%E9%85%8D%E7%BD%AEetcdctl"><span class="toc-number">4.7.5.</span> <span class="toc-text">
          master配置etcdctl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2node"><span class="toc-number">4.8.</span> <span class="toc-text">
          部署node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E6%A0%87%E7%AD%BE"><span class="toc-number">4.9.</span> <span class="toc-text">
          打标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6Cilium"><span class="toc-number">5.</span> <span class="toc-text">
          部署网络插件Cilium</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87helm3"><span class="toc-number">5.1.</span> <span class="toc-text">
          准备helm3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Cilium"><span class="toc-number">5.2.</span> <span class="toc-text">
          部署Cilium</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">7.</span> <span class="toc-text">
          测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">7.1.</span> <span class="toc-text">
          验证集群可用性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AFdocker%EF%BC%8Ckubelet"><span class="toc-number">7.2.</span> <span class="toc-text">
          重启docker，kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo%E6%B5%8B%E8%AF%95"><span class="toc-number">7.3.</span> <span class="toc-text">
          demo测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4dns"><span class="toc-number">7.3.1.</span> <span class="toc-text">
          验证集群dns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95nginx%E6%98%AF%E5%90%A6%E9%80%9A"><span class="toc-number">7.3.2.</span> <span class="toc-text">
          测试nginx是否通</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ipvs%E9%AA%8C%E8%AF%81"><span class="toc-number">7.3.3.</span> <span class="toc-text">
          ipvs验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8F%AF%E8%A7%86%E5%8C%96%E7%A5%9E%E5%99%A8-Hubble"><span class="toc-number">7.4.</span> <span class="toc-text">
          网络可视化神器 Hubble</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Meteor across</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">27</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">1</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Hao Zhang</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.1.1</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>